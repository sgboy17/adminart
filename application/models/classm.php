<?phpclass Classm extends My_Model{    function __construct()    {        parent::__construct();    }    function get_items()    {        return $this->db->order_by('class_code ASC')->where('branch_id', $this->session->userdata('branch'))->where('deleted', 0)->get($this->prefix . 'class');    }    function get_item_by_id($id)    {        return $this->db->where('class_id', $id)->where('branch_id', $this->session->userdata('branch'))->get($this->prefix . 'class')->row_array();    }    function get_item_by_class_code($class_code)    {        return $this->db->where('branch_id', $this->session->userdata('branch'))->where('class_code', $class_code)->get($this->prefix . 'class')->row_array();    }    function get_active_items()    {        return $this->db->order_by('class_code ASC')->where('deleted', 0)->where('branch_id', $this->session->userdata('branch'))->where('status', 1)->get($this->prefix . 'class');    }    function get_item_by_teacher_id($teacher_id)    {        return $this->db->where('teacher_id', $teacher_id)->where('branch_id', $this->session->userdata('branch'))->get($this->prefix . 'class')->result();    }    function get_name($id)    {        $result = $this->db->where('class_id', $id)->where('branch_id', $this->session->userdata('branch'))->get($this->prefix . 'class')->row_array();        if (!empty($result)) return $result['class_code'];        else return '';    }    function get_class_list()    {        if (isset($_GET['f_search']) && !empty($_GET['f_search'])) {            $this->db->where('(' . $this->prefix . 'class' . '.class_code LIKE "%' . $_GET['f_search'] . '%")');        }        if (isset($_GET['f_branch_id']) && !empty($_GET['f_branch_id'])) {            $this->db->where($this->prefix . 'class' . '.branch_id', $_GET['f_branch_id']);        }        if (isset($_GET['f_program_id']) && !empty($_GET['f_program_id'])) {            $this->db->where($this->prefix . 'class' . '.program_id', $_GET['f_program_id']);        }        if (isset($_GET['f_teacher_id']) && !empty($_GET['f_teacher_id'])) {            $this->db->where($this->prefix . 'class' . '.teacher_id', $_GET['f_teacher_id']);        }        if (isset($_GET['f_status']) && !empty($_GET['f_status'])) {            $this->db->where($this->prefix . 'class' . '.status', $_GET['f_status']);        }        ////////////////////////////////////        $this->db->select($this->prefix . 'class' . ".*, " . $this->prefix . 'teacher' . ".name as teacher_name");        $this->db->join($this->prefix . 'teacher', $this->prefix . 'class' . ".teacher_id = " . $this->prefix . 'teacher' . ".teacher_id", "left");        $this->db->where($this->prefix . 'class' . '.deleted', 0)->where($this->prefix . 'class' . '.branch_id', $this->session->userdata('branch'))->order_by($this->prefix . 'class' . '.updated_at DESC');        $result_item = $this->db->get($this->prefix . 'class');        $data['iTotalRecords'] = $data['iTotalDisplayRecords'] = $result_item->num_rows();        $list = array();        foreach ($result_item->result() as $row) {            $list[] = array(                'id' => $row->class_id,                'teacher_id' => $row->teacher_id,                'teacher_name' => $row->teacher_name,                'class_code' => $row->class_code,                'date_start' => $row->date_start,                'date_end' => $row->date_end,                'day_in_week' => $row->day_in_week,                'current_num_student' => $row->current_num_student,                'note' => $row->note,                'status' => $row->status,                'created_at' => $row->created_at,                'updated_at' => $row->updated_at,            );        }        ////////////////////////////////////        $data['aaData'] = array();        $i = -1;        foreach ($list as $row):            $i++;            if (!($i >= $_GET['iDisplayStart'] && $i < $_GET['iDisplayStart'] + $_GET['iDisplayLength'])) continue;            if ($row['status'] == 1) $status = '<span class="text-success">Active</span>';            else $status = '<span class="text-danger">Inactive</span>';            $cate = array(                '<div class="checkbox-list"><label><input type="checkbox" value="' . $row['id'] . '" class="id" /></label></div>',                $row['class_code'],                $row['teacher_name'],                $status,                $row['updated_at'],                '<a style="margin-right: 5px;" href="#class_detail" data-toggle="modal" onclick="load_class_edit(\'' . $row['id'] . '\');"><span class="label label-info">Sửa <i class="fa fa-edit"></i></span></a>                <a style="margin-right: 5px;" href="javascript:;" onclick="delete_class(\'' . $row['id'] . '\');"><span class="label label-danger">Xoá <i class="fa fa-times"></i></span></a>                <a style="display: inline-block; margin-bottom: 5px;" href="#class_attendance" data-toggle="modal" class="label label-default"  onclick="load_class_attendance(\'' . $row['id'] . '\',null);"><span>Điểm danh</span></a>',            );            $data['aaData'][] = $cate;        endforeach;        echo json_encode($data);    }    function delete_class()    {        if ($this->input->post('id')) {            $id = $this->input->post('id');            $ids = explode(',', $id);            foreach ($ids as $id) {                if (!empty($id)) {                    $this->db->update($this->prefix . 'class', array('deleted' => 1), array('class_id' => $id, 'branch_id' => $this->session->userdata('branch')));                }            }        }    }    function save_class_add()    {        $exist_class_code = $this->db->where('class_code', $this->input->post('class_code'))->where($this->prefix . 'class' . '.branch_id', $this->session->userdata('branch'))->where('deleted', 0)->get($this->prefix . 'class');        if ($exist_class_code->num_rows() > 0) {            echo json_encode(20);            die;        }        $data = array(            'class_id' => $this->uuid->v4(),            'branch_id' => $this->session->userdata('branch'),            //'program_id' => $this->input->post('program_id'),            'teacher_id' => $this->input->post('teacher_id'),            'class_code' => $this->input->post('class_code'),            //'type' => $this->input->post('type'),            //'date_start' => format_save_date($this->input->post('date_start')),            //'date_end' => format_save_date($this->input->post('date_end')),            'status' => $this->input->post('status'),            'is_special' => $this->input->post('is_special'),            'created_at' => date("Y/m/d h:i:s"),            'updated_at' => date("Y/m/d h:i:s"),        );        $this->db->insert($this->prefix . 'class', $data);        $class_id = $data['class_id'];        $class_hour_day = $this->input->post('class_hour_day');        if ($class_hour_day != null) {            foreach ($this->input->post('class_hour_day') as $k => $v) {                if ($v != "") {                    $class_room = $this->input->post('class_room');                    $class_hour_from_time = $this->input->post('class_hour_from_time');                    $class_hour_to_time = $this->input->post('class_hour_to_time');                    if ($v != ""                        && isset($class_room[$k]) && $class_room[$k] != null                        && isset($class_hour_from_time[$k]) && $class_hour_from_time[$k] != null                        && isset($class_hour_to_time[$k]) && $class_hour_to_time[$k] != null                    ) {                        $data_hour = array(                            'class_hour_id' => $this->uuid->v4(),                            "room_id" => isset($class_room[$k]) ? $class_room[$k] : "",                            "class_id" => $class_id,                            "from_time" => isset($class_hour_from_time[$k]) ? $class_hour_from_time[$k] : "",                            "to_time" => isset($class_hour_to_time[$k]) ? $class_hour_to_time[$k] : "",                            "date_id" => $v,                            'created_at' => date("Y/m/d h:i:s"),                            'updated_at' => date("Y/m/d h:i:s"),                        );                        $this->db->insert($this->prefix . 'class_hour', $data_hour);                    }                }            }        }    }    function save_class_edit()    {        if ($this->input->post('id')) {            $id = $this->input->post('id');            $exist_class_code = $this->db->where('class_id !=', $id)->where('class_code', $this->input->post('class_code'))->where($this->prefix . 'class' . '.branch_id', $this->session->userdata('branch'))->where('deleted', 0)->get($this->prefix . 'class');            if ($exist_class_code->num_rows() > 0) {                echo json_encode(20);                die;            }            $data = array(                //'program_id' => $this->input->post('program_id'),                'teacher_id' => $this->input->post('teacher_id'),                'class_code' => $this->input->post('class_code'),                //'type' => $this->input->post('type'),                //'date_start' => format_save_date($this->input->post('date_start')),                //'date_end' => format_save_date($this->input->post('date_end')),                'note' => $this->input->post('note'),                'status' => $this->input->post('status'),                'is_special' => $this->input->post('is_special'),                'updated_at' => date("Y/m/d h:i:s"),            );            $this->db->update($this->prefix . 'class', $data, array('class_id' => $id, 'branch_id' => $this->session->userdata('branch')));            $class_hour_day = $this->input->post('class_hour_day');            if ($class_hour_day != null) {                $this->db->update($this->prefix . 'class_hour', array('deleted' => 1), array('class_id' => $id));                foreach ($this->input->post('class_hour_day') as $k => $v) {                    $class_room = $this->input->post('class_room');                    $class_hour_from_time = $this->input->post('class_hour_from_time');                    $class_hour_to_time = $this->input->post('class_hour_to_time');                    if ($v != ""                        && isset($class_room[$k]) && $class_room[$k] != null                        && isset($class_hour_from_time[$k]) && $class_hour_from_time[$k] != null                        && isset($class_hour_to_time[$k]) && $class_hour_to_time[$k] != null                    ) {                        $data_hour = array(                            'class_hour_id' => $this->uuid->v4(),                            "room_id" => isset($class_room[$k]) ? $class_room[$k] : "",                            "class_id" => $id,                            "from_time" => isset($class_hour_from_time[$k]) ? $class_hour_from_time[$k] : "",                            "to_time" => isset($class_hour_to_time[$k]) ? $class_hour_to_time[$k] : "",                            "date_id" => $v,                            'created_at' => date("Y/m/d h:i:s"),                            'updated_at' => date("Y/m/d h:i:s"),                        );                        $this->db->insert($this->prefix . 'class_hour', $data_hour);                    }                }            }        }    }    function load_class_add()    {        ?>        <div class="modal-body">            <div class="col-md-6">                <h4>Thông tin cơ bản</h4>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Mã lớp:</div>                    </div>                    <div class="col-md-8">                        <input type="text" id="class_code" name="class_code" placeholder="Mã lớp"                               class="form-control"></input>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Giáo viên:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="teacher_id">                            <option value="">- Giáo viên -</option>                            <?php                            $teacher_list = $this->teacherm->get_active_items();                            foreach ($teacher_list->result() as $row) { ?>                                <option value="<?php echo $row->teacher_id ?>"><?php echo $row->name ?></option>                            <?php } ?>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Tình trạng:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="status">                            <option value="">- Tình trạng -</option>                            <option value="1">Active</option>                            <option value="2">Inactive</option>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Phụ thu giờ vàng:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="is_special">                            <option value="">- Phụ thu giờ vàng -</option>                            <option value="1">Có</option>                            <option value="2">Không</option>                        </select>                    </div>                </div>                <div class="clearfix"></div>            </div>            <div class="col-md-6" id="class_hour">                <h4>Giờ học                    <!--<a class="label label-info pull-right" onclick="module_load_class_hour_add();">Thêm</a>--></h4>                <div id="class_hour_template" style="display: none;">                    <div class="col-md-4">                        <select class="form-control flag-update-info" name="class_room[]">                            <option value="">- Phòng học -</option>                            <?php                            $room_list = $this->roomm->get_active_items();                            foreach ($room_list->result() as $row) { ?>                                <option value="<?php echo $row->room_id ?>"><?php echo $row->name ?></option>                            <?php } ?>                        </select>                    </div>                    <div class="col-md-3">                        <select class="form-control tooltips flag-update-info" name="class_hour_day[]" placeholder="Thứ"                                data-html="true" data-original-title="Thứ">                            <option value="1">Thứ 2</option>                            <option value="2">Thứ 3</option>                            <option value="3">Thứ 4</option>                            <option value="4">Thứ 5</option>                            <option value="5">Thứ 6</option>                            <option value="6">Thứ 7</option>                            <option value="0">Chủ nhật</option>                        </select>                    </div>                    <div class="col-md-2">                        <input type="text" class="form-control tooltips timepicker flag-update-info"                               name="class_hour_from_time[]" value="08:00 AM" placeholder="Từ giờ"                               data-html="true" data-original-title="Từ giờ"></input>                    </div>                    <div class="col-md-2">                        <input type="text" class="form-control tooltips timepicker flag-update-info"                               name="class_hour_to_time[]" value="10:00 AM" placeholder="Đến giờ"                               data-html="true" data-original-title="Đến giờ"></input>                    </div>                    <div class="col-md-1" style="line-height: 32px;">                        <!--<a class="label label-danger flag-delete-hour"                           onclick="module_delete_class_hour($(this));">Xoá</a>-->                    </div>                    <div class="clearfix m-b-sm8"></div>                </div>                <div class="clearfix"></div>                <!--                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Ngày bắt đầu:</div>                    </div>                    <div class="col-md-8">                        <input type="text" name="date_start" placeholder="Ngày bắt đầu"                               class="form-control datepicker flag-update-info"></input>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Ngày kết thúc:</div>                    </div>                    <div class="col-md-8 expired-date">                        <input type="text" name="date_end" placeholder="Ngày kết thúc"                               class="form-control datepicker"></input>                    </div>                </div>                <div class="clearfix"></div>-->                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Ghi chú:</div>                    </div>                    <div class="col-md-8">                        <textarea name="note" placeholder="Ghi chú" class="form-control"></textarea>                    </div>                </div>                <div class="clearfix"></div>            </div>        </div>        <div class="clearfix m-b"></div>        <div class="modal-footer">            <a class="btn btn-success" onclick="save_class_add($(this))">Lưu</a>            <a data-dismiss="modal" style="display:none;">Processing...</a>            <a class="btn btn-default" data-dismiss="modal">Huỷ</a>        </div>        <?php    }    function load_expired_date()    {        $data = array();        $expired_date = "";        $data['class_hour'] = array();        $day = isset($_POST['class_hour_day']) ? $_POST['class_hour_day'] : null;        $from_time = isset($_POST['class_hour_from_time']) ? $_POST['class_hour_from_time'] : null;        $to_time = isset($_POST['class_hour_to_time']) ? $_POST['class_hour_to_time'] : null;        if (count($day) > 0) {            foreach ($day as $k => $v) {                if (isset($from_time[$k]) && isset($to_time[$k])) {                    //$data['class_hour'][] = array($v,$from_time[$k],$to_time[$k]);                    $data['list_date'][] = $v;                    $data['date_total_time'][$v] = (strtotime($to_time[$k]) - strtotime($from_time[$k])) / 3600;                    $data['from_time'][$v] = strtotime($from_time[$k]);                    $data['to_time'][$v] = strtotime($to_time[$k]);                }            }            $data['program_id'] = isset($_POST['program_id']) ? $_POST['program_id'] : null;            $data['class_type'] = isset($_POST['type']) ? $_POST['type'] : null;            $data['date_start'] = isset($_POST['date_start']) ? $_POST['date_start'] : null;            $data['total_hour'] = 32;            $data['date_off_array'] = array();            $expired_date = excuteExpireDate($data);            if ($expired_date != "") {                $expired_date = format_get_date($expired_date['date']);            }            //$list_teacher = excuteTeacherFree($data);        }        ?>        <input type="text" name="date_end" placeholder="Ngày kết thúc" value="<?php echo $expired_date; ?>"               class="form-control datepicker"></input>    <?php }    function load_class_edit()    {        $id = $this->input->post('id');        $result = $this->db->where('class_id', $id)->where('branch_id', $this->session->userdata('branch'))->where('deleted', 0)->get($this->prefix . 'class');        if ($result->num_rows() == 0) {            echo '<p style="text-align:center;margin-top:10px;">No data found!</p>';        } else {            $result = $result->row();            $class_hour = $this->db->where('class_id', $id)->where('deleted', 0)->order_by("date_id", "asc")->get($this->prefix . 'class_hour')->result();            ?>            <input type="hidden" name="id" id="id" value="<?php echo $result->class_id ?>"/>            <div class="modal-body">                <div class="col-md-6">                    <h4>Thông tin cơ bản</h4>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Mã lớp:</div>                        </div>                        <div class="col-md-8">                            <input type="text" id="class_code" name="class_code"                                   value="<?php echo $result->class_code ?>" placeholder="mã lớp"                                   class="form-control"></input>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Giáo viên:</div>                        </div>                        <div class="col-md-8">                            <select class="form-control" name="teacher_id">                                <option value="">- Giáo viên -</option>                                <?php                                $teacher_list = $this->teacherm->get_items();                                foreach ($teacher_list->result() as $row) { ?>                                    <option                                            value="<?php echo $row->teacher_id ?>" <?php if ($result->teacher_id == $row->teacher_id) echo 'selected=""'; ?>><?php echo $row->name ?></option>                                <?php } ?>                            </select>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Tình trạng:</div>                        </div>                        <div class="col-md-8">                            <select class="form-control" name="status">                                <option value="">- Tình trạng -</option>                                <option value="1" <?php if ($result->status == 1) echo 'selected=""'; ?>>Active</option>                                <option value="2" <?php if ($result->status == 2) echo 'selected=""'; ?>>Inactive                                </option>                            </select>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Phụ thu giờ vàng:</div>                        </div>                        <div class="col-md-8">                            <select class="form-control" name="is_special">                                <option value="">- Phụ thu giờ vàng -</option>                                <option value="1" <?php if ($result->is_special == 1) echo 'selected=""'; ?>>Có</option>                                <option value="2" <?php if ($result->is_special == 2) echo 'selected=""'; ?>>Không</option>                            </select>                        </div>                    </div>                    <div class="clearfix"></div>                </div>                <div class="col-md-6" id="class_hour">                    <h4>Giờ học                        <!--<a class="label label-info pull-right" onclick="module_load_class_hour_add();">Thêm</a>-->                    </h4>                    <div id="class_hour_template" style="display: none;">                        <div class="col-md-4">                            <select class="form-control flag-update-info" name="class_room[]">                                <option value="">- Phòng học -</option>                                <?php                                $room_list = $this->roomm->get_active_items();                                foreach ($room_list->result() as $row) { ?>                                    <option value="<?php echo $row->room_id ?>"><?php echo $row->name ?></option>                                <?php } ?>                            </select>                        </div>                        <div class="col-md-3">                            <select class="form-control tooltips flag-update-info" name="class_hour_day[]"                                    placeholder="Thứ" data-html="true" data-original-title="Thứ">                                <option value="1">Thứ 2</option>                                <option value="2">Thứ 3</option>                                <option value="3">Thứ 4</option>                                <option value="4">Thứ 5</option>                                <option value="5">Thứ 6</option>                                <option value="6">Thứ 7</option>                                <option value="0">Chủ nhật</option>                            </select>                        </div>                        <div class="col-md-2">                            <input type="text" class="form-control tooltips timepicker flag-update-info"                                   name="class_hour_from_time[]" value="08:00 AM" placeholder="Từ giờ"                                   data-html="true" data-original-title="Từ giờ"></input>                        </div>                        <div class="col-md-2">                            <input type="text" class="form-control tooltips timepicker flag-update-info"                                   name="class_hour_to_time[]" value="10:00 AM" placeholder="Đến giờ"                                   data-html="true" data-original-title="Đến giờ"></input>                        </div>                        <div class="col-md-1" style="line-height: 32px;">                            <a class="label label-danger flag-delete-hour" onclick="module_delete_class_hour($(this));">Xoá</a>                        </div>                        <div class="clearfix m-b-sm8"></div>                    </div>                    <?php //if (count($class_hour) > 0) { ?>                    <?php /*foreach ($class_hour as $k => $v) {*/ $v = isset($class_hour[0])?$class_hour[0]:null; ?>                    <div class="row">                        <div class="col-md-4">                            <select class="form-control flag-update-info" name="class_room[]">                                <option value="">- Phòng học -</option>                                <?php                                $room_list = $this->roomm->get_active_items();                                foreach ($room_list->result() as $row) { ?>                                    <option value="<?php echo $row->room_id ?>" <?php if (isset($v->room_id) && $v->room_id == $row->room_id) echo 'selected=""'; ?>>                                        <?php echo $row->name; ?>                                    </option>                                <?php } ?>                            </select>                        </div>                        <div class="col-md-3">                            <select class="form-control tooltips flag-update-info" name="class_hour_day[]"                                    placeholder="Thứ" data-html="true" data-original-title="Thứ">                                <option value="1" <?php if (isset($v->date_id) && $v->date_id == 1) echo 'selected=""'; ?>>Thứ 2                                </option>                                <option value="2" <?php if (isset($v->date_id) && $v->date_id == 2) echo 'selected=""'; ?>>Thứ 3                                </option>                                <option value="3" <?php if (isset($v->date_id) && $v->date_id == 3) echo 'selected=""'; ?>>Thứ 4                                </option>                                <option value="4" <?php if (isset($v->date_id) && $v->date_id == 4) echo 'selected=""'; ?>>Thứ 5                                </option>                                <option value="5" <?php if (isset($v->date_id) && $v->date_id == 5) echo 'selected=""'; ?>>Thứ 6                                </option>                                <option value="6" <?php if (isset($v->date_id) && $v->date_id == 6) echo 'selected=""'; ?>>Thứ 7                                </option>                                <option value="0" <?php if (isset($v->date_id) && $v->date_id == 0) echo 'selected=""'; ?>>Chủ nhật                                </option>                            </select>                        </div>                        <div class="col-md-2">                            <input type="text" class="form-control tooltips timepicker flag-update-info valid"                                   name="class_hour_from_time[]"                                   value="<?php echo isset($v->from_time) ? $v->from_time : "08:00 AM"; ?>"                                   placeholder="Từ giờ" data-html="true" data-original-title="Từ giờ">                        </div>                        <div class="col-md-2">                            <input type="text" class="form-control tooltips timepicker flag-update-info valid"                                   name="class_hour_to_time[]"                                   value="<?php echo isset($v->to_time) ? $v->to_time : "10:00 AM"; ?>"                                   placeholder="Đến giờ" data-html="true" data-original-title="Đến giờ">                        </div>                        <div class="col-md-1" style="line-height: 32px;">                            <!--<a class="label label-danger flag-delete-hour"                               onclick="module_delete_class_hour($(this));">Xoá</a>-->                        </div>                        <div class="clearfix m-b-sm8"></div>                    </div>                    <?php //} ?>                    <?php //} ?>                    <div class="clearfix"></div>                    <!--                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Ngày bắt đầu:</div>                        </div>                        <div class="col-md-8">                            <input type="text" name="date_start"                                   value="<?php echo format_get_date($result->date_start); ?>"                                   placeholder="Ngày bắt đầu" class="form-control datepicker flag-update-info"></input>                        </div>                    </div>                    <div class="clearfix"></div>-->                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Ghi chú:</div>                        </div>                        <div class="col-md-8">                            <textarea name="note" placeholder="Ghi chú"                                      class="form-control"><?php echo $result->note ?></textarea>                        </div>                    </div>                    <div class="clearfix"></div>                </div>            </div>            <div class="clearfix m-b"></div>            <div class="modal-footer">                <a class="btn btn-success" onclick="save_class_edit($(this))">Lưu</a>                <a data-dismiss="modal" style="display:none;">Processing...</a>                <a class="btn btn-default" data-dismiss="modal">Huỷ</a>            </div>            <?php        }    }    function load_class_attendance()    {                $student_class_id = $this->input->post('student_class_id');        $class_id = $this->input->post('id');        if ($student_class_id != null) {            $student_class = $this->db->select($this->prefix . 'student_class.*,' . $this->prefix . 'student.name as student_name')                ->distinct()                ->where($this->prefix . 'student_class.student_class_id', $student_class_id)                ->where($this->prefix . 'student_class.deleted', 0)                ->where($this->prefix . 'student_class.status', 1)                ->where($this->prefix . 'student.deleted', 0)                ->from($this->prefix . 'student_class')                ->join($this->prefix . 'student', $this->prefix . 'student.student_id = ' . $this->prefix . 'student_class.student_id')                ->limit(1)                ->get();        } else {            $student_class = $this->db->select($this->prefix . 'student_class.*,' . $this->prefix . 'student.name as student_name')                ->where('class_id', $class_id)                ->where($this->prefix . 'student_class.deleted', 0)                ->where($this->prefix . 'student_class.status', 1)                ->where($this->prefix . 'student.deleted', 0)                ->from($this->prefix . 'student_class')                ->join($this->prefix . 'student', $this->prefix . 'student.student_id = ' . $this->prefix . 'student_class.student_id')                ->get();            $date_change_by_class = $this->changeschedulem->get_items_by_class_id($class_id);        }        if (($student_class_id != null && $student_class->num_rows() == 0) || ($student_class_id == null && $student_class->num_rows() == 0 && count($date_change_by_class) == 0)) {            echo '<p style="text-align:center;margin-top:10px;">No data found!</p>';        } else {            $class_hour_date = $day_in_week = $attendance_days = $hide_days  = $extends_days = $from_time = $to_time = $student_schedule = array();            if($student_class->num_rows() > 0)                $result = $student_class->result();            else                $result = null;            // get ngay nghi            $dateoff = $this->dateoffm->get_items();            foreach ($dateoff->result() as $row) {                $list_date_off[] = $row->date;            }            $date_start = $this->studentclassm->get_earliest_start_date($class_id, $student_class_id);            $date_end = $this->studentclassm->get_lastest_end_date($class_id, $student_class_id);            $class = $this->classm->get_item_by_id($class_id);            if (empty($class)) return false;            /* - START xu ly thoi gian hoc cua lop - */            $class_hour = $this->classhourm->get_items_by_class_id($class_id);            if (empty($class_hour)) return false;            //print_r($class_hour->result());die;            foreach ($class_hour->result() as $sub_row) {                $day_in_week[] = $sub_row->date_id;                $class_hour_date[$sub_row->class_hour_id] = $sub_row->date_id;                $from_time[$sub_row->date_id] = $sub_row->from_time;                $to_time[$sub_row->date_id] = $sub_row->to_time;                $schedules = $this->studentschedulem->get_items_by_class_hour_id($sub_row->class_hour_id);                foreach ($schedules as $schedule) {                    $student_schedule[$schedule->student_id][$schedule->date] = $schedule->student_schedule_id;                }            }            /* - END xu ly thoi gian hoc cua lop - */            $temp_result = array();            if($result != null) {                //print_R($result);die;                foreach ($result as $row) {                    if ($this->studentm->check_past_class($row->student_class_id, $row->student_id)) continue;                    if (!in_array($row->student_id, array_keys($temp_result))) {                        $temp_result[$row->student_id] = $row->student_name;                    }                    /* - START xu ly ngay hoc cua tung hoc vien - */                    $data_to = array(                        'list_date' => $day_in_week,                        'date_start' => date('d/m/Y', strtotime($row->date_start)),                        'date_end' => date('d/m/Y', strtotime($row->date_end)),                        'list_date_off' => $list_date_off,                        'from_time' => $from_time,                        'to_time' => $to_time,                    );                    $schedule_data_temp[$row->student_id] = excuteScheduleDate($data_to);                    // get change date                    $date_change = $this->changeschedulem->get_items_by_student_id($row->student_id);                    foreach ($date_change->result() as $row) {                        if($row->class_id == $class_id) {                            $extends_days[$row->student_id][$row->from_date] = $row->to_date;                        }                        else                        {                            $hide_days[$row->student_id][$row->from_date] = $row->to_date;                        }                    }                    if (isset($extends_days[$row->student_id]) && count($extends_days[$row->student_id]) > 0) {                        $cday = array_keys($extends_days[$row->student_id]);                        foreach ($schedule_data_temp[$row->student_id] as $k => $temp) {                            if(in_array($temp, $cday)) {                                $schedule_data_temp[$row->student_id][$k] = $extends_days[$row->student_id][$temp];                            }                        }                    }                    if(isset($hide_days[$row->student_id]) && count($hide_days[$row->student_id]) > 0) {                        $hday = array_keys($hide_days[$row->student_id]);                        foreach ($schedule_data_temp[$row->student_id] as $k => $temp) {                            if (isset($hday) && in_array($temp, $hday)) {                                unset($schedule_data_temp[$row->student_id][$k]);                            }                        }                    }                    $schedule_data_temp[$row->student_id] = array_merge($schedule_data_temp[$row->student_id]);                }            }            if ($student_class_id != null) {                $date_change_by_class = $this->changeschedulem->get_items_by_student_id($result[0]->student_id);            } else {                $date_change_by_class = $this->changeschedulem->get_items_by_class_id($class_id);            }            if(count($date_change_by_class) > 0) {                foreach ($date_change_by_class->result() as $row) {                    if (!in_array($row->student_id, array_keys($temp_result))) {                        if($date_start ==null || ($date_start !=null && strtotime($date_start) > strtotime($row->to_date))) {                            $date_start = $row->to_date;                        }elseif($date_end == null || ($date_end != null && strtotime($date_end) < strtotime($row->to_date))) {                            $date_end = $row->to_date;                        }                        $temp_result[$row->student_id]  = $this->studentm->get_name($row->student_id);;                        $schedule_data_temp[$row->student_id][] = $row->to_date;                        $class_hour = $this->classhourm->get_item_by_class_id($row->class_id);                                            }                }            }            //if($date_start != null && $date_end != null) {                while (strtotime($date_start) <= strtotime($date_end)) {                    if (!in_array($date_start, $list_date_off)) {                        $getdate = getdate(strtotime($date_start));                        if (in_array($getdate['wday'], $day_in_week)) {                            $attendance_days[] = array(                                'class_hour_id' => array_search($getdate['wday'], $class_hour_date),                                'date' => $date_start                            );                        }                    }                    $date_start = date("Y-m-d", strtotime("+1 day", strtotime($date_start)));                }            /*}            else            {*/            //}            if (count($temp_result) == 0) {                echo '<p style="text-align:center;margin-top:10px;">No data found!</p>';                die;            }            if ($student_class_id != null) { // diem danh theo hoc vien                $student_class_detail = $this->studentclassm->get_item_by_id($student_class_id);            }            ?>            <div class="modal-body">                <table class="table" style="float:left;width: 150px;margin-bottom: 0px; ">                    <thead>                    <tr>                        <th style="text-align:center;font-weight:bold;">Tên học viên</th>                    </tr>                    </thead>                    <tbody>                    <?php foreach ($temp_result as $row) {                        ?>                        <tr>                            <th scope="row" nowrap><?php echo $row ?></th>                        </tr>                    <?php } ?>                    </tbody>                </table>                <div style="overflow-y: auto;">                    <table class="table" style="margin-bottom: 0px;">                        <thead>                        <tr>                            <?php foreach ($attendance_days as $day) {                                $current_year = date("Y");                                $year = date("Y", strtotime($day['date']));                                ?>                                <th class="text-center"><?php echo $current_year == $year ? format_get_date($day['date'], "d/m") : format_get_date($day['date'], "d/m"); ?></th>                            <?php } ?>                        </tr>                        </thead>                        <tbody>                        <?php foreach ($temp_result as $student_id => $student_name ) {                                if (empty($student_class_id)) { // diem danh theo lop                                    $student_class_detail = $this->studentclassm->get_item_by_student_class($student_id, $class_id);                                }                            ?>                            <tr>                                <?php                                foreach ($attendance_days as $day) {                                    if (empty($student_class_detail)) { // change schedule                                        $change_schedule = $this->changeschedulem->get_item_by_student_class($student_id, $class_id, $day['date']);                                        if (!empty($change_schedule)) {                                            $student_class_detail = $this->studentclassm->get_item_by_id($change_schedule['student_class_id']);                                        }                                    }                                    $value = isset($student_schedule[$student_id][$day['date']]) ? $student_schedule[$student_id][$day['date']] : '';                                    $checked = isset($student_schedule[$student_id][$day['date']]) ? 'checked' : '';                                    $readonly = (date("d/m/Y", strtotime($day['date'])) != date("d/m/Y")) || (date("d/m/Y", strtotime($day['date'])) == date("d/m/Y") && strtotime($day['date']) > strtotime('now')) ? ' disabled' : '';                                    ?>                                    <?php if (isset($schedule_data_temp[$student_id]) && in_array($day['date'],$schedule_data_temp[$student_id])) { ?>                                        <td class="text-center"><input                                                onclick="save_student_schedule(this, '<?php echo $day['class_hour_id']; ?>', '<?php echo $student_id ?>', '<?php echo format_get_date($day['date']); ?>', '<?php echo $student_class_detail['hour']; ?>')"                                                type="checkbox"                                                value="<?php echo $value ?>" <?php echo $checked ?> <?php echo $readonly ?>>                                        </td>                                    <?php } else {                                        ?>                                        <td class="text-center" style="height:39px;"></td>                                    <?php } ?>                                <?php } ?>                            </tr>                        <?php } ?>                        </tbody>                    </table>                </div>            </div>            <div class="clearfix m-b"></div>            <div class="modal-footer">                <a class="btn btn-default" data-dismiss="modal">Huỷ</a>            </div>            <?php        }    }    function load_class_by_date()    {        $date = $this->input->post('date');        $class_id = $this->input->post('class_id');        $getdate = getdate(strtotime(format_save_date($date)));        $data = $this->db->select('c.class_id, c.class_code')            ->from($this->prefix . 'class c')            ->join($this->prefix . 'class_hour ch', 'ch.class_id = c.class_id')            ->where('c.deleted', 0)            ->where('ch.deleted', 0)            ->where('date_id', $getdate['wday'])            //->where('ch.class_id !=', $class_id)            ->where('branch_id', $this->session->userdata('branch'))            ->get();        echo '<option value="">- Lớp -</option>';        if ($data->num_rows() > 0) {            foreach ($data->result() as $row) {                echo '<option value="' . $row->class_id . '">' . $row->class_code . '</option>';            }        }    }}