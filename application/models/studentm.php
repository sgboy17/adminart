<?phpclass Studentm extends My_Model{    private $parent_type = array(        '1' => 'Cha',        '2' => 'Mẹ',        '3' => 'Anh',        '4' => 'Chị',        '5' => 'Ông',        '6' => 'Bà'    );    private $how_to_know = array(        '1' => 'Bạn bè',        '2' => 'Tình cờ đi ngang qua',        '3' => 'Tờ rơi',        '4' => 'Internet',        '5' => 'Báo chí',        '6' => 'Khác'    );    function __construct()    {        parent::__construct();    }    function get_items()    {        return $this->db->order_by('created_at DESC')            ->where('deleted', 0)            ->where('branch_id', $this->session->userdata('branch'))            ->get($this->prefix . 'student');    }    function get_student_study_program($program_id)    {        return $this->db->from($this->prefix . 'student s')            ->join($this->prefix . 'student_class sc', 's.student_id = sc.student_id', 'left')            ->where('sc.program_id =', $program_id)            ->where('s.deleted', 0)            ->where('sc.deleted', 0)            ->where('s.branch_id', $this->session->userdata('branch'))->group_by('s.student_id')->get();    }    function get_item_by_id($id)    {        return $this->db->where('student_id', $id)->get($this->prefix . 'student')->row_array();    }    function count_item_by_user($user_id)    {        return $this->db->where('user_id', $user_id)->get($this->prefix . 'student')->num_rows();    }    function get_money_by_program($student_id, $program_id)    {        return $this->db->where('student_id', $student_id)->where('program_id', $program_id)->where('deleted', 0)->get($this->prefix . 'student_money')->row_array();    }    function get_money_by_student_id($student_id)    {        $money = 0;        $money_data = $this->db->where('student_id', $student_id)->where('deleted', 0)->get($this->prefix . 'student_money');        foreach ($money_data->result() as $value) {            $money += $value->money;        }        return $money;    }    function get_id_by_code($code)    {        $row = $this->db->select('student_id')            ->where('student_code', $code)            ->where('deleted', 0)            ->where('branch_id', $this->session->userdata('branch'))            ->get($this->prefix . 'student')            ->row();        if (!empty($row)) {            return $row->student_id;        } else {            return '';        }    }    function get_name($id)    {        $result = $this->db->select('name')            ->where('student_id', $id)            ->where('branch_id', $this->session->userdata('branch'))            ->get($this->prefix . 'student')            ->row_array();        if (!empty($result)) {            return $result['name'];        } else {            return '';        }    }    function generate_code($branch_id)    {        $branch = $this->branchm->get_item_by_id($branch_id);        if (empty($branch)) $branch_code = 'MD';        else if (empty($branch['code'])) {            $branch_name = explode(' ', $branch['name']);            $first_char = '';            foreach ($branch_name as $row) {                if (isset($row[0]) && !empty($row[0])) $first_char .= strtoupper($row[0]);            }            if (!empty($first_char)) $branch_code = $first_char;            else $branch_code = 'MD';        } else {            $branch_code = $branch['code'];        }        $last_result = $this->db->order_by('student_code DESC')->where('student_code LIKE "%-' . $branch_code . '-%"')->limit(1)->get($this->prefix . 'student')->row();        if (!empty($last_result)) {            $code = explode('-', $last_result->student_code);            foreach ($code as $row) {                if (((int)$row) != 0) $last_number = (int)$row + 1;            }        } else $last_number = 1;        $result_code = 'HV-' . $branch_code . '-' . str_pad($last_number, 6, 0, STR_PAD_LEFT);        return $result_code;    }    function generate_invoice_code($branch_id)    {        $branch = $this->branchm->get_item_by_id($branch_id);        if (empty($branch)) $branch_code = 'MD';        else if (empty($branch['code'])) {            $branch_name = explode(' ', $branch['name']);            $first_char = '';            foreach ($branch_name as $row) {                if (isset($row[0]) && !empty($row[0])) $first_char .= strtoupper($row[0]);            }            if (!empty($first_char)) $branch_code = $first_char;            else $branch_code = 'MD';        } else {            $branch_code = $branch['code'];        }        $last_result = $this->db->order_by('created_at DESC')->where('invoice_code LIKE "%-' . $branch_code . '-%"')->limit(1)->get($this->prefix . 'invoice')->row();        $last_number = 1;        if (!empty($last_result)) {            $code = explode('-', $last_result->invoice_code);            foreach ($code as $row) {                if (((int)$row) != 0) $last_number = (int)$row + 1;            }        };        $result_code = 'IV-' . $branch_code . '-' . str_pad($last_number, 6, 0, STR_PAD_LEFT);        return $result_code;    }    function get_current_class_status($student_id, $student_class_id)    {        $action = $this->db->where('object_id', $student_id)            ->where('(`from` = "' . $student_class_id . '" OR `to` = "' . $student_class_id . '")')            ->where('deleted', 0)            ->order_by('created_at DESC')            ->limit(1, 0)            ->get($this->prefix . 'action')->row();        if (!empty($action)) return $action;        else return false;    }    function check_past_class($from, $student_id)    {        $is_past = false;        $studentclass = $this->studentclassm->get_item_by_student_id($student_id);        foreach ($studentclass->result() as $sc) {            $action = $this->db->where('from', $from)->where('to', $sc->student_class_id)->where('deleted', 0)                ->get($this->prefix . 'action')->row();            if (!empty($action)) return true;        }        return false;    }    function load_student_history()    {        $id = $this->input->post('student_id');        $result = $this->db->select('sc.program_id')            ->distinct("sc.program_id")            ->from($this->prefix . 'action a')            ->join($this->prefix . 'student_class sc', 'a.from = sc.student_class_id')            ->where('sc.student_id', $id)            ->where('a.action', STUDENT_STATUS_3)            ->get();        if ($result->num_rows() == 0) {            echo '<p style="text-align:center;margin-top:10px;">No data found!</p>';        } else {            $result = $result->result();            $student_name = $this->studentm->get_name($id);            ?>            <div class="modal-body">                <div class="portlet light">                    <div class="portlet-title">                        <div class="caption">                            <span                                class="caption-subject font-green-sharp bold uppercase"> Tên: <b><?php echo $student_name; ?></b></span>                        </div>                    </div>                    <div class="portlet-body">                        <div class="row">                            <div class="col-sm-12 col-md-12">                                <div class="table-container table-responsive">                                    <table class="table">                                        <thead>                                        <tr role="row" class="heading">                                            <th style="text-align:center">STT</th>                                            <th style="text-align:center">Chương trình học</th>                                        </tr>                                        </thead>                                        <tbody>                                        <?php $count = 1;                                        foreach ($result as $value) {                                            $program_name = $this->programm->get_name($value->program_id);                                            ?>                                            <tr>                                                <td style="text-align:center"><?php echo $count; ?></td>                                                <td style="text-align:center"><?php echo $program_name; ?></td>                                            </tr>                                            <?php $count++;                                        } ?>                                        </tbody>                                    </table>                                </div>                            </div>                        </div>                    </div>                </div>                <div class="clearfix"></div>            </div>            <div class="modal-footer">                <a class="btn btn-default" data-dismiss="modal">Huỷ</a>                <div class="clearfix"></div>            </div>            <?php        }    }    function get_all_student_list()    {        if (isset($_GET['f_search']) && !empty($_GET['f_search'])) {            $this->db->where('(' . $this->prefix . 'student' . '.name LIKE "%' . $_GET['f_search'] . '%")');            $this->db->or_where('(' . $this->prefix . 'student' . '.student_code LIKE "%' . $_GET['f_search'] . '%")');            $this->db->or_where('(' . $this->prefix . 'student' . '.parent_name LIKE "%' . $_GET['f_search'] . '%")');        }        if (isset($_GET['f_branch_id']) && !empty($_GET['f_branch_id'])) {            $this->db->where($this->prefix . 'student' . '.branch_id', $_GET['f_branch_id']);        }        ////////////////////////////////////        $this->db->where($this->prefix . 'student' . '.deleted', 0)->order_by($this->prefix . 'student' . '.updated_at DESC');        $result_item = $this->db->get($this->prefix . 'student');        $data['iTotalRecords'] = $data['iTotalDisplayRecords'] = $result_item->num_rows();        $data['aaData'] = array();        $list = array();        if ($result_item->num_rows() > 0) {            foreach ($result_item->result() as $row) {                $list[] = array(                    'id' => $row->student_id,                    'name' => $row->name,                    'student_code' => $row->student_code,                    'sex' => $row->sex,                    'birthday' => $row->birthday,                    'student_school' => $row->student_school,                    'student_class' => $row->student_class,                    'parent_name' => $row->parent_name,                    'parent_type' => $row->parent_type,                    'parent_birthday' => $row->parent_birthday,                    'parent_work' => $row->parent_work,                    'address' => $row->address,                    'phone' => $row->phone,                    'email' => $row->email,                    'note' => $row->note,                    'status' => $row->status,                    'created_at' => $row->created_at,                    'updated_at' => $row->updated_at,                    'branch_id' => $row->branch_id,                );            }            ////////////////////////////////////            $i = -1;            $count = 1;            foreach ($list as $row):                $i++;                if (!($i >= $_GET['iDisplayStart'] && $i < $_GET['iDisplayStart'] + $_GET['iDisplayLength'])) continue;                if ($row['status'] == 1) $status = '<span class="text-success">Active</span>';                else $status = '<span class="text-danger">Inactive</span>';                $money = $this->get_money_by_student_id($row['id']);                $branch_name = $this->branchm->get_name($row['branch_id']);                $student_class_data = $this->studentclassm->get_items_by_student_id($row['id']);                $level_data = array();                $level_unique_data = array();                foreach ($student_class_data->result() as $value) {                    if (!in_array($value->program_id, $level_unique_data)) {                        $level_unique_data[] = $value->program_id;                        $program_name = null;                        $program_name = $this->programm->get_name($value->program_id);                        if ($program_name != "") {                            $level_data[] = $program_name;                        }                    }                }                $level = implode(",", $level_data);                $text = "<strong style='font-size: 12px;'>Trung tâm:</strong> " . $branch_name . "<br/>";                $text .= "<strong style='font-size: 12px;'>Ngày sinh:</strong> " . format_get_date($row['birthday']) . "<br/>";                $text .= "<strong style='font-size: 12px;'>Địa chỉ:</strong> " . $row['address'] . "<br/>";                $text .= "<strong style='font-size: 12px;'>Email:</strong> " . $row['email'] . "<br/>";                $text .= "<strong style='font-size: 12px;'>Điện thoại:</strong> " . $row['phone'] . "<br/>";                $text .= "<strong style='font-size: 12px;'>Số tiền tích luỹ:</strong> " . number_format($money) . "đ";                $cate = array(                    $count++,                    $branch_name,                    $row['name'],                    $text,                    $level,                    $row['parent_name'],                    $status,                    $row['created_at'],                );                $data['aaData'][] = $cate;            endforeach;        }        echo json_encode($data);    }    function load_all_student_branch()    {        $result = $this->db->select('s.*')->from($this->prefix . 'student s')            ->where('s.deleted', 0)            ->order_by('s.created_at', 'desc')            ->get();        if ($result->num_rows() == 0) {            echo '<p style="text-align:center;margin-top:10px;">No data found!</p>';        } else {            $result = $result->result();            ?>            <div class="modal-body">                <div class="portlet light">                    <div class="portlet-title">                        <div class="caption">                            <i class="icon-bar-chart font-green-sharp"></i>                            <span class="caption-subject font-green-sharp bold uppercase">Học viên</span>                        </div>                        <div class="tools">                            <div class="form-group pull-right m-r-sm">                                <input type="text" class="form-control" id="all_search" placeholder="Tìm kiếm">                            </div>                            <div class="form-group pull-right m-r-sm">                                <select class="form-control" name="branch_id" id="all_branch_id">                                    <option value="">- Trung tâm -</option>                                    <?php                                    $branch_list = $this->branchm->get_items();                                    foreach ($branch_list->result() as $row) { ?>                                        <option value="<?php echo $row->branch_id ?>"><?php echo $row->name ?></option>                                    <?php } ?>                                </select>                            </div>                        </div>                    </div>                    <div class="portlet-body">                        <div class="row">                            <div class="col-sm-12 col-md-12">                                <div class="table-container table-responsive">                                    <table id="all_student_list" class="table">                                        <thead>                                        <tr role="row" class="heading">                                            <th style="text-align:center">STT</th>                                            <th style="text-align:left">Trung tâm</th>                                            <th style="text-align:left">Tên học viên</th>                                            <th style="text-align:left">Thông tin học viên</th>                                            <th style="text-align:left">Cấp độ</th>                                            <th style="text-align:left">Tên phụ huynh</th>                                            <th e="text-align:center">Trạng thái</th>                                            <th style="text-align:center">Ngày đăng ký</th>                                        </tr>                                        </thead>                                        <tbody></tbody>                                    </table>                                </div>                            </div>                        </div>                    </div>                </div>                <div class="clearfix"></div>            </div>            <div class="modal-footer">                <a class="btn btn-default" data-dismiss="modal">Huỷ</a>                <div class="clearfix"></div>            </div>            <?php        }    }    function load_student_branch_transfer()    {        $result = $this->db->select('s.*,a.*,a.created_at as action_created_at')->from($this->prefix . 'action a')            ->join($this->prefix . 'student s', 'a.object_id = s.student_id')            ->where('a.to', $this->session->userdata('branch'))            ->where('s.branch_id !=', $this->session->userdata('branch'))            ->where('a.action', STUDENT_STATUS_8)            ->where('a.deleted', 0)            ->get();        if ($result->num_rows() == 0) {            echo '<p style="text-align:center;margin-top:10px;">No data found!</p>';        } else {            $result = $result->result();            ?>            <div class="modal-body">                <div class="portlet light">                    <div class="portlet-body">                        <div class="row">                            <div class="col-sm-12 col-md-12">                                <div class="table-container table-responsive">                                    <table class="table">                                        <thead>                                        <tr role="row" class="heading">                                            <th style="text-align:center">STT</th>                                            <th style="text-align:center">Thông tin học viên</th>                                            <th style="text-align:center">Ngày tạo yêu cầu</th>                                            <th style="text-align:center"></th>                                        </tr>                                        </thead>                                        <tbody>                                        <?php $count = 1;                                        $money = 0;                                        foreach ($result as $value) {                                            $money = $this->get_money_by_student_id($value->student_id);                                            $branch_name = $this->branchm->get_name($value->branch_id);                                            $text = "<strong style='font-size: 12px;'>Tên học viên:</strong> " . $value->name . "<br/>";                                            $text .= "<strong style='font-size: 12px;'>Trung tâm:</strong> " . $branch_name . "<br/>";                                            $text .= "<strong style='font-size: 12px;'>Ngày sinh:</strong> " . format_get_date($value->birthday) . "<br/>";                                            $text .= "<strong style='font-size: 12px;'>Tên phụ huynh:</strong> " . $value->parent_name . "<br/>";                                            $text .= "<strong style='font-size: 12px;'>Địa chỉ:</strong> " . $value->address . "<br/>";                                            $text .= "<strong style='font-size: 12px;'>Email:</strong> " . $value->email . "<br/>";                                            $text .= "<strong style='font-size: 12px;'>Điện thoại:</strong> " . $value->phone . "<br/>";                                            $text .= "<strong style='font-size: 12px;'>Số tiền tích luỹ:</strong> " . number_format($money) . "đ";                                            $action_class = '<a style="display: inline-block; margin-bottom: 5px;" href="#" class="label label-primary" onclick="save_student_branch_transfer($(this),\'' . $value->action_id . '\',1);"><span class="">Xác nhận</span></a>';                                            $action_class .= '&nbsp;<a style="display: inline-block; margin-bottom: 5px;" href="#" class="label label-info" onclick="save_student_branch_transfer($(this),\'' . $value->action_id . '\',0);"><span class="">Huỷ</span></a>';                                            ?>                                            <tr>                                                <td style="text-align:center"><?php echo $count; ?></td>                                                <td style="text-align:left"><?php echo $text; ?></td>                                                <td style="text-align:left"><?php echo format_get_date($value->action_created_at); ?></td>                                                <td style="text-align:left"><?php echo $action_class; ?></td>                                            </tr>                                            <?php $count++;                                        } ?>                                        </tbody>                                    </table>                                </div>                            </div>                        </div>                    </div>                </div>                <div class="clearfix"></div>            </div>            <div class="modal-footer">                <a class="btn btn-default" data-dismiss="modal">Huỷ</a>                <div class="clearfix"></div>            </div>            <?php        }    }    function load_transfer_friend()    {        $student_id = $this->input->post('student_id');        $branch_id = $this->input->post('branch_id');        $program_id = $this->input->post('program_id');        $student_name = $this->studentm->get_name($student_id);        $money_data = $this->studentm->get_money_by_program($student_id, $program_id);        $branch_name = $this->branchm->get_name($branch_id);        $program_name = $this->programm->get_name($program_id);        if ($money_data != null) {            ?>            <div class="modal-body">                <input type="hidden" name="branch_id" value="<?php echo $this->session->userdata('branch') ?>">                <input type="hidden" name="student_id" value="<?php echo $student_id; ?>">                <input type="hidden" name="program_id" value="<?php echo $program_id; ?>">                <input type="hidden" name="action" value="<?php echo STUDENT_STATUS_9; ?>">                <input type="hidden" name="student_money_id" value="<?php echo $money_data['student_money_id']; ?>">                <div class="row">                    <div class="modal-body">                        <div class="form-group m-t-sm">                            <div class="col-md-4">                                <div class="m-t-sm">Tên học viên:</div>                            </div>                            <div class="col-md-8">                                <b><?php echo $student_name; ?></b>                            </div>                        </div>                        <div class="clearfix"></div>                        <div class="form-group m-t-sm">                            <div class="col-md-4">                                <div class="m-t-sm">Trung tâm hiện tại:</div>                            </div>                            <div class="col-md-8">                                <b><?php echo $branch_name; ?></b>                            </div>                        </div>                        <div class="clearfix"></div>                        <div class="forup m-t-sm">                            <div class="col-md-4">                                <div class="m-t-sm">Chương trình:</div>                            </div>                            <div class="col-md-8">                                <b><?php echo $program_name; ?></b>                            </div>                        </div>                        <div class="clearfix"></div>                        <div class="form-group m-t-sm">                            <div class="col-md-4">                                <div class="m-t-sm">Số giờ:</div>                            </div>                            <div class="col-md-8">                                <b><?php echo isset($money_data['hour']) ? $money_data['hour'] : 0; ?></b>                            </div>                        </div>                        <div class="clearfix"></div>                        <div class="form-group m-t-sm">                            <div class="col-md-4">                                <div class="m-t-sm">Đến học viên:</div>                            </div>                            <div class="col-md-8">                                <select class="form-control" name="to_student_id" readonly="readonly">                                    <?php                                    $student_study_program_list = $this->studentm->get_student_study_program($program_id);                                    $list_student_study_program = array();                                    foreach ($student_study_program_list->result() as $row) {                                        $list_student_study_program[] = $row->student_id;                                    }                                    $student_list = $this->studentm->get_items();                                    foreach ($student_list->result() as $row) {                                        ?>                                        <?php if ($row->student_id == $student_id && in_array($row->student_id, $list_student_study_program)) continue; ?>                                        <option                                            value="<?php echo $row->student_id ?>"><?php echo $row->name ?></option>                                    <?php } ?>                                </select>                            </div>                        </div>                        <div class="clearfix"></div>                        <div class="form-group m-t-sm">                            <div class="col-md-4">                                <div class="m-t-sm">Lý do:</div>                            </div>                            <div class="col-md-8">                    <textarea name="note" placeholder="lý do"                              class="form-control"></textarea>                            </div>                        </div>                        <div class="clearfix"></div>                    </div>                </div>            </div>            </div>            <div class="modal-footer">                <a class="btn btn-success" onclick="save_transfer_friend($(this))">Lưu</a>                <a data-dismiss="modal" style="display:none;">Processing...</a>                <a class="btn btn-default" data-dismiss="modal">Huỷ</a>                <div class="clearfix"></div>            </div>            <?php        }    }    function load_branch_change()    {        $id = $this->input->post('student_id');        $student_name = $this->studentm->get_name($id);        $branch_name = $this->branchm->get_name($this->session->userdata('branch'));        $branch_data = $this->branchm->get_item_by_id($this->session->userdata('branch'));        ?>        <div class="modal-body">            <input type="hidden" name="branch_id" value="<?php echo $this->session->userdata('branch') ?>">            <input type="hidden" name="object_id" value="<?php echo $id; ?>">            <input type="hidden" name="action" value="<?php echo STUDENT_STATUS_8; ?>">            <input type="hidden"                   value="<?php echo $this->invoicem->generate_code($this->session->userdata('branch')); ?>"                   name="invoice_code" class="form-control"></input>            <div class="row">                <div class="modal-body">                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Tên học viên:</div>                        </div>                        <div class="col-md-8">                            <b><?php echo $student_name; ?></b>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Trung tâm hiện tại:</div>                        </div>                        <div class="col-md-8">                            <b><?php echo $branch_name; ?></b>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Đến trung tâm:</div>                        </div>                        <div class="col-md-8">                            <select class="form-control" name="to_branch_id" readonly="readonly">                                <?php                                $center_list = $this->branchm->get_items();                                foreach ($center_list->result() as $row) {                                    ?>                                    <?php if ($row->branch_id == $this->session->userdata('branch')) continue; ?>                                    <option                                        value="<?php echo $row->branch_id ?>"><?php echo $row->name ?></option>                                <?php } ?>                            </select>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Tiền phụ thu:</div>                        </div>                        <div class="col-md-8">                            <input type="text" name="total" placeholder="số tiền" class="form-control"                                   value="<?php echo isset($branch_data['fee_change_branch']) ? $branch_data['fee_change_branch'] : 0; ?>"></input>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Lý do:</div>                        </div>                        <div class="col-md-8">                    <textarea name="note" placeholder="lý do"                              class="form-control"></textarea>                        </div>                    </div>                    <div class="clearfix"></div>                </div>            </div>        </div>        </div>        <div class="modal-footer">            <a class="btn btn-success" onclick="save_branch_change($(this))">Xử lý phụ thu</a>            <a data-dismiss="modal" style="display:none;">Processing...</a>            <a class="btn btn-default" data-dismiss="modal">Huỷ</a>            <div class="clearfix"></div>        </div>        <?php    }    function get_student_list()    {        $expect_student = array();        $accept_student = array();        if (isset($_GET['f_type']) && !empty($_GET['f_type'])) {            if ($_GET['f_type'] == 1) { // tiem nang                $student_1 = $this->db->select('s.student_id')                    ->from($this->prefix . 'student as s')                    ->join($this->prefix . 'student_class as sc', 's.student_id = sc.student_id')                    ->where('s.deleted', 0)                    ->where('s.branch_id', $this->session->userdata('branch'))                    ->where('s.status', 1)->get();                foreach ($student_1->result() as $v) {                    $expect_student[] = $v->student_id;                }            } else if ($_GET['f_type'] == 2) { // moi                $student_2 = $this->db->select('object_id')                    ->from($this->prefix . 'action')                    ->where('branch_id', $this->session->userdata('branch'))                    ->where('deleted', 0)                    ->where('action', STUDENT_STATUS_0)                    ->where('created_at <=', 'DATE_ADD(NOW(),INTERVAL 7 DAYS)')                    ->get();                foreach ($student_2->result() as $v) {                    $accept_student[] = $v->object_id;                }            } else if ($_GET['f_type'] == 3) { // sap het han                $student_3 = $this->db->select('s.student_id')                    ->from($this->prefix . 'student as s')                    ->join($this->prefix . 'student_class as sc', 's.student_id = sc.student_id')                    ->where('s.deleted', 0)                    ->where('s.branch_id', $this->session->userdata('branch'))                    ->where('sc.date_end <=', 'DATE_ADD(NOW(),INTERVAL 7 DAYS)')                    ->get();                foreach ($student_3->result() as $v) {                    $accept_student[] = $v->student_id;                }            } else if ($_GET['f_type'] == 4) { // bao luu                $student_4 = $this->db->select('object_id')                    ->from($this->prefix . 'action')                    ->where('branch_id', $this->session->userdata('branch'))                    ->where('deleted', 0)                    ->where('action', STUDENT_STATUS_1)                    ->where('created_at <=', 'DATE_ADD(NOW(),INTERVAL 7 DAYS)')                    ->get();                foreach ($student_4->result() as $v) {                    $accept_student[] = $v->object_id;                }            } else if ($_GET['f_type'] == 5) { // da nghi                $student_5 = $this->db->select('object_id')                    ->from($this->prefix . 'action')                    ->where('branch_id', $this->session->userdata('branch'))                    ->where('deleted', 0)                    ->where('action', STUDENT_STATUS_4)                    ->where('created_at <=', 'DATE_ADD(NOW(),INTERVAL 7 DAYS)')                    ->get();                foreach ($student_5->result() as $v) {                    $accept_student[] = $v->object_id;                }            }        }        if (isset($_GET['f_search']) && !empty($_GET['f_search'])) {            $this->db->where('(name LIKE "%' . $_GET['f_search'] . '%")');        }        if (isset($_GET['f_parent_type']) && !empty($_GET['f_parent_type'])) {            $this->db->where('parent_type', $_GET['f_parent_type']);        }        if (isset($_GET['f_status']) && !empty($_GET['f_status'])) {            $this->db->where('status', $_GET['f_status']);        }        ////////////////////////////////////        $result_item = $this->db->where('deleted', 0)            ->where('branch_id', $this->session->userdata('branch'))            ->order_by('student_code DESC')            ->get($this->prefix . 'student');        $data['iTotalRecords'] = $data['iTotalDisplayRecords'] = $result_item->num_rows();        $list = array();        foreach ($result_item->result() as $row) {            if (                !isset($_GET['f_type']) ||                empty($_GET['f_type']) ||                (                    isset($_GET['f_type']) &&                    !empty($_GET['f_type']) &&                    ($_GET['f_type'] == 1 && !in_array($row->student_id, $expect_student)) ||                    (in_array($row->student_id, $accept_student))                )            ) {                $list[] = array(                    'id' => $row->student_id,                    'name' => $row->name,                    'student_code' => $row->student_code,                    'sex' => $row->sex,                    'birthday' => $row->birthday,                    'student_school' => $row->student_school,                    'student_class' => $row->student_class,                    'parent_name' => $row->parent_name,                    'parent_type' => $row->parent_type,                    'parent_birthday' => $row->parent_birthday,                    'parent_work' => $row->parent_work,                    'address' => $row->address,                    'phone' => $row->phone,                    'email' => $row->email,                    'note' => $row->note,                    'status' => $row->status,                    'created_at' => $row->created_at,                    'updated_at' => $row->updated_at,                    'branch_id' => $row->branch_id,                );            }        }        ////////////////////////////////////        $data['aaData'] = array();        $i = -1;        foreach ($list as $row):            $i++;            if (!($i >= $_GET['iDisplayStart'] && $i < $_GET['iDisplayStart'] + $_GET['iDisplayLength'])) {                continue;            }            $money = $this->get_money_by_student_id($row['id']);            $text = "<strong style='font-size: 12px;'>Tên học viên:</strong> " . $row['name'] . "<br/>";            $text .= "<strong style='font-size: 12px;'>Ngày sinh:</strong> " . format_get_date($row['birthday']) . "<br/>";            $text .= "<strong style='font-size: 12px;'>Tên phụ huynh:</strong> " . $row['parent_name'] . "<br/>";            $text .= "<strong style='font-size: 12px;'>Địa chỉ:</strong> " . $row['address'] . "<br/>";            $text .= "<strong style='font-size: 12px;'>Email:</strong> " . $row['email'] . "<br/>";            $text .= "<strong style='font-size: 12px;'>Điện thoại:</strong> " . $row['phone'] . "<br/>";            $text .= "<strong style='font-size: 12px;'>Số tiền tích luỹ:</strong> " . number_format($money) . "đ";            $is_branch_transfer = 0;            $branch_transfer_data = $this->actionm->get_branch_transfer_action($row['branch_id'], $row['id']);            if ($branch_transfer_data != null) {                $is_branch_transfer = 1;                $to_branch_name = $this->branchm->get_name($branch_transfer_data->to);                $action_class = '<br><span style="font-size: 12px;">Chờ xác nhận chuyển sang trung tâm <b>' . $to_branch_name . '</b><br/>Lý do: ' . $branch_transfer_data->note . '</span>';                $invoice_data = $this->invoicem->get_current_by_student_id($row['id'], INVOICE_TYPE_4);                if ($invoice_data->num_rows() != null) {                    $invoice_data = current($invoice_data->result());                    $action_class .= '<br><a style="display: inline-block; margin-bottom: 5px;" href="#" class="label label-info" onclick="print_invoice(\'' . $invoice_data->invoice_id . '\');"><span class="">In Hoá đơn</span></a>';                    $action_class .= '&nbsp;<a style="display: inline-block; margin-bottom: 5px;" href="#" class="label label-primary" onclick="delete_branch_transfer(\'' . $branch_transfer_data->action_id . '\');"><span class="">Huỷ yêu cầu chuyển trung tâm</span></a>';                } else {                    $action_class .= '<br><a style="display: inline-block; margin-bottom: 5px;" href="#" class="label label-primary" onclick="delete_branch_transfer(\'' . $branch_transfer_data->action_id . '\');"><span class="">Huỷ yêu cầu chuyển trung tâm</span></a>';                }            }            if ($is_branch_transfer == 0) {                $action_class = '<a style="display: inline-block; margin-bottom: 5px;" href="#student_action" class="label label-primary" data-toggle="modal" onclick="load_student_action(\'' . $row['id'] . '\',\'' . $row['branch_id'] . '\',\'' . STUDENT_STATUS_0 . '\',0);"><span class="">' . STUDENT_STATUS_0 . '</span></a>';                $program_list = $this->programm->get_items();                $studentclass = $this->studentclassm->get_items_by_student_id_for_list($row['id']);                $multi_student_class_id = array();                $multi_student_class_data = array();                $studentclass_1 = $this->studentclassm->get_items_by_student_id($row['id']);                foreach ($studentclass_1->result() as $sc) {                    $class = $this->classm->get_item_by_id($sc->class_id);                    if (empty($class)) continue;                    $program = $this->programm->get_item_by_id($sc->program_id);                    if (empty($program)) continue;                    $past_class = $this->studentm->check_past_class($sc->student_class_id, $row['id']);                    if ($past_class) continue;                    $multi_student_class_data[$sc->program_id][] = $sc->student_class_id;                    $multi_student_class_id[] = $sc->student_class_id;                }                /* Invoice */                $action_class .= '&nbsp;<a style="display: inline-block; margin-bottom: 5px;" href="#invoice_action" class="label label-info" data-toggle="modal" onclick="load_invoice_action(\'' . $row['id'] . '\',\'' . $row['branch_id'] . '\',\'' . INVOICE_TYPE_6 . '\');"><span class="">' . INVOICE_TYPE_6 . '</span></a>';                $action_class .= '&nbsp;<a style="display: inline-block; margin-bottom: 5px;" href="#invoice_action" class="label label-info" data-toggle="modal" onclick="load_invoice_action(\'' . $row['id'] . '\',\'' . $row['branch_id'] . '\',\'' . INVOICE_TYPE_2 . '\');"><span class="">' . INVOICE_TYPE_2 . '</span></a>';                /* Invoice */                $action_class .= '&nbsp;<a style="display: inline-block; margin-bottom: 5px;" href="#invoice_action" class="label label-info" data-toggle="modal" onclick="load_invoice_action(\'' . $row['id'] . '\',\'' . $row['branch_id'] . '\',\'' . INVOICE_TYPE_4 . '\');"><span class="">' . INVOICE_TYPE_4 . '</span></a>';                if (!empty($multi_student_class_id)) $action_class .= '&nbsp;<a style="display: inline-block; margin-bottom: 5px;" href="#student_schedule" data-toggle="modal" class="label label-primary" onclick="load_student_schedule(\'' . implode('|', $multi_student_class_id) . '\');"><span>Thời khóa biểu</span></a>';                $action_class .= '&nbsp;<a style="display: inline-block; margin-bottom: 5px;" href="#student_history" data-toggle="modal" class="label label-info" onclick="load_student_history(\'' . $row['id'] . '\');"><span>Lịch sử học</span></a>';                /* Đặt cọc */                $deposit = $this->invoicem->get_current_by_student_id($row['id'], INVOICE_TYPE_6, null);                if ($deposit->num_rows() > 0) {                    foreach ($deposit->result() as $d) {                        if ($d->is_used == 1) continue;                        $action_class .= sprintf('<p style="font-size: 12px;">Đã đặt cọc %s ngày %s</p>', number_format($d->total, 0), format_get_date($d->created_at));                    }                }                /* Đặt cọc */                /* Học thử */                $sql = "SELECT p.name, a.created_at                    FROM " . $this->prefix . "program p                    JOIN " . $this->prefix . "action a ON a.`from` = p.program_id                    WHERE a.deleted =  0                    AND p.deleted =  0                    AND a.object_id = ?                    AND a.action = ?                    AND p.branch_id = ?";                $paid_program = $this->db->query($sql, array($row['id'], STUDENT_STATUS_11, $this->session->userdata('branch')));                if ($paid_program->num_rows() > 0) {                    foreach ($paid_program->result() as $d) {                        $action_class .= sprintf('<p style="font-size: 12px;">Đã thanh toán học phí chương trình %s ngày %s</p>', $d->name, format_get_date($d->created_at));                    }                }                /* Học thử */                foreach ($program_list->result() as $pl) {                    $start_date = $end_date = date('Y-m-d');                    $min = 0;                    $list_date = array();                    $list_date_off = array();                    $dateoff = $this->dateoffm->get_items();                    foreach ($dateoff->result() as $r) {                        $list_date_off[] = $r->date;                    }                    $from_time = array();                    $to_time = array();                    $date_total_time = array();                    $study_hour_time = 0;                    if (isset($multi_student_class_data[$pl->program_id])) {                        $study_hour = excuteStudyHour($multi_student_class_data[$pl->program_id]);                        if (isset($study_hour[$row['id']])) {                            $study_hour_time = array_sum($study_hour[$row['id']]);                        }                    }                    foreach ($studentclass_1->result() as $sc) {                        if ($sc->program_id != $pl->program_id) continue;                        if ($min == 0 || strtotime($sc->date_start) < $min) $min = strtotime($sc->date_start);                        $class = $this->classm->get_item_by_id($sc->class_id);                        if (empty($class)) continue;                        $class_hour = $this->classhourm->get_item_by_class_id($class['class_id']);                        if (empty($class_hour)) continue;                        $date_start = date('d/m/Y', strtotime($sc->date_start));                        $weekday = date('N', strtotime(format_save_date($date_start)));                        $list_date[] = $weekday;                        $date_total_time[$weekday] = $sc->hour;                        $from_time[$weekday] = $class_hour['from_time'];                        $to_time[$weekday] = $class_hour['to_time'];                    }                    $start_date = date('Y-m-d', $min);                    $data_to = array(                        'list_date' => $list_date,                        'date_start' => date('d/m/Y', $min),                        'total_hour' => $pl->total_time + $this->actionm->get_extra_days_action($this->session->userdata('branch'), $row['id'], $pl->program_id),                        'list_date_off' => $list_date_off,                        'date_total_time' => $date_total_time,                        'from_time' => $from_time,                        'to_time' => $to_time,                    );                    $expire_date = excuteExpireDate($data_to);                    $end_date = $expire_date['date'];                    $count_studentclass = 0;                    $extra = $this->actionm->get_extra_days_action($this->session->userdata('branch'), $row['id'], $pl->program_id);                    if ($extra != 0) {                        $extra = " - <i>Đã gia hạn: " . $extra . " buổi</i>";                    } else {                        $extra = "";                    }                    foreach ($studentclass->result() as $sc) {                        $check_show = false;                        if ($sc->status == 1) {                            $check_show = true;                        }                        if ($sc->program_id != $pl->program_id) continue;                        $class = $this->classm->get_item_by_id($sc->class_id);                        if (empty($class)) continue;                        $program = $this->programm->get_item_by_id($sc->program_id);                        if (empty($program)) continue;                        $past_class = $this->studentm->check_past_class($sc->student_class_id, $row['id']);                        if ($past_class) continue;                        $count_studentclass++;                        $current_action = $this->studentm->get_current_class_status($row['id'], $sc->student_class_id);                        if ($count_studentclass == 1 && !empty($current_action)) {                            if ($current_action->action == STUDENT_STATUS_10) { // Học thử                                $student_class = $this->studentclassm->get_item_by_id($current_action->from);                                $action_class .= '<h5 style="line-height: 18px;border-bottom: 1px dotted black; margin-top: 5px;margin-bottom: 5px;"><b>' . STUDENT_STATUS_10 . ': ' . $pl->name . ' (' . date('d/m', strtotime($student_class['date_start'])) . ' - ' . date('d/m', strtotime($student_class['date_end'])) . ')</b><br>Đã học: ' . $study_hour_time . '/' . $current_action->note . ' giờ</h5>';                            } else {                                $action_class .= '<h5 style="line-height: 18px;border-bottom: 1px dotted black; margin-top: 5px;margin-bottom: 5px;"><b>' . $pl->name . ' (' . date('d/m', strtotime($start_date)) . ' - ' . date('d/m', strtotime($end_date)) . ')</b>' . $extra . '<i style="float:right;">Đã học: ' . $study_hour_time . '/' . $program['total_time'] . ' giờ</i></h5>';                            }                            if ($current_action->action == STUDENT_STATUS_0 ||                                $current_action->action == STUDENT_STATUS_1 ||                                $current_action->action == STUDENT_STATUS_2 ||                                $current_action->action == STUDENT_STATUS_5 ||                                $current_action->action == STUDENT_STATUS_14 ||                                $current_action->action == STUDENT_STATUS_6                            ) { // Đăng ký mới || Chuyển lớp || Đăng ký học tiếp || Học tiếp                                //print_R( $current_action->action);                                // len lop                                $action_class .= '&nbsp;<a style="display: inline-block; margin-bottom: 5px;" href="#student_action" class="label label-primary" data-toggle="modal" onclick="load_student_action(\'' . $row['id'] . '\',\'' . $row['branch_id'] . '\',\'' . STUDENT_STATUS_3 . '\',\'' . $sc->student_class_id . '\');"><span class="">' . STUDENT_STATUS_3 . '</span></a>';                                // chuyen gio                                $action_class .= '&nbsp;<a style="display: inline-block; margin-bottom: 5px;" href="#student_action" class="label label-primary" data-toggle="modal" onclick="load_student_action(\'' . $row['id'] . '\',\'' . $row['branch_id'] . '\',\'' . STUDENT_STATUS_12 . '\',\'' . $sc->student_class_id . '\');"><span class="">' . STUDENT_STATUS_12 . '</span></a>';                                // them buoi                                $action_class .= '&nbsp;<a style="display: inline-block; margin-bottom: 5px;" href="#student_action" class="label label-primary" data-toggle="modal" onclick="load_student_action(\'' . $row['id'] . '\',\'' . $row['branch_id'] . '\',\'' . STUDENT_STATUS_14 . '\',\'' . $sc->student_class_id . '\');"><span class="">' . STUDENT_STATUS_14 . '</span></a>';                                // gia han                                $action_class .= '&nbsp;<a style="display: inline-block; margin-bottom: 5px;" href="#student_action" class="label label-primary" data-toggle="modal" onclick="load_student_action(\'' . $row['id'] . '\',\'' . $row['branch_id'] . '\',\'' . STUDENT_STATUS_13 . '\',\'' . $sc->student_class_id . '\');"><span class="">' . STUDENT_STATUS_13 . '</span></a>';                                // nghi hoc                                $action_class .= '&nbsp;<a style="display: inline-block; margin-bottom: 5px;" href="#student_action" class="label label-primary" data-toggle="modal" onclick="load_student_action(\'' . $row['id'] . '\',\'' . $row['branch_id'] . '\',\'' . STUDENT_STATUS_4 . '\',\'' . $sc->student_class_id . '\');"><span class="">' . STUDENT_STATUS_4 . '</span></a>';                            }                            if ($current_action->action == STUDENT_STATUS_3) { // Lên lớp                                $action_class .= '<span style="font-size: 12px;">Ngày xác nhận lên lớp: ' . date('d/m/Y', strtotime($current_action->to)) . (!empty($current_action->note) ? '<br/>Lý do: ' . $current_action->note : '') . '</span>';                                $action_class .= '<br/><a style="display: inline-block; margin-bottom: 5px;" href="#student_action" class="label label-primary" data-toggle="modal" onclick="load_student_action(\'' . $row['id'] . '\',\'' . $row['branch_id'] . '\',\'' . STUDENT_STATUS_5 . '\',\'' . $sc->student_class_id . '\');"><span class="">' . STUDENT_STATUS_5 . '</span></a>';                                break;                            }                            if ($current_action->action == STUDENT_STATUS_4) { // Nghỉ học                                $action_class .= '<span style="font-size: 12px;">Ngày xác nhận nghỉ học: ' . date('d/m/Y', strtotime($current_action->from)) . (!empty($current_action->note) ? '<br/>Lý do: ' . $current_action->note : '') . '</span>';                                $action_transfer_friend_data = $this->actionm->get_transfer_friend_action(STUDENT_STATUS_9, $sc->student_id, $pl->program_id);                                if ($action_transfer_friend_data != null) {                                    $friend_name = $this->studentm->get_name($action_transfer_friend_data['to']);                                    $action_class .= '<br><span style="font-size: 12px;">Xác nhận chuyển giờ cho học viên: ' . $friend_name . '<br>Lúc: ' . $action_transfer_friend_data['created_at'] . '</span>';                                }                                $action_class .= '<br/><a style="display: inline-block; margin-bottom: 5px;" href="#student_action" class="label label-primary" data-toggle="modal" onclick="load_student_action(\'' . $row['id'] . '\',\'' . $row['branch_id'] . '\',\'' . STUDENT_STATUS_5 . '\',\'' . $sc->student_class_id . '\');"><span class="">' . STUDENT_STATUS_5 . '</span></a>';                                $money_data = $this->studentm->get_money_by_program($row['id'], $sc->program_id);                                if ($money_data != null) {                                    $action_class .= '&nbsp;<a style="display: inline-block; margin-bottom: 5px;" href="#transfer_friend" class="label label-primary" data-toggle="modal" onclick="load_transfer_friend(\'' . $row['id'] . '\',\'' . $row['branch_id'] . '\',\'' . $sc->program_id . '\');"><span class="">' . STUDENT_STATUS_9 . '</span></a>';                                }                                break;                            }                        }                        if ($check_show && !empty($current_action)) {                            $action_class .= '<h5 style="margin-top: 5px;margin-bottom: 5px;"><b>+ ' . (!empty($class['name']) ? $class['name'] : $class['class_code']) . '</b></h5>';                        }                        if (!empty($current_action)) {                            if ($current_action->action == STUDENT_STATUS_10) { // Học thử                                $action_class .= '&nbsp;<a style="display: inline-block; margin-bottom: 5px;" href="#class_attendance" data-toggle="modal" class="label label-info"  onclick="load_class_attendance(\'' . $sc->class_id . '\',\'' . $sc->student_class_id . '\');"><span>Điểm danh</span></a>';                            }                            if ($current_action->action == STUDENT_STATUS_0 ||                                $current_action->action == STUDENT_STATUS_2 ||                                $current_action->action == STUDENT_STATUS_14 ||                                $current_action->action == STUDENT_STATUS_5 ||                                $current_action->action == STUDENT_STATUS_6                            ) { // Đăng ký mới || Chuyển lớp || Đăng ký học tiếp || Học tiếp                                $action_class .= '<span style="font-size: 12px;">' . (!empty($current_action->note) ? 'Ghi chú: ' . $current_action->note . '<br/>' : '') . '</span>';                                $action_class .= '<a style="display: inline-block; margin-bottom: 5px;" href="#student_action" class="label label-info" data-toggle="modal" onclick="load_student_action(\'' . $row['id'] . '\',\'' . $row['branch_id'] . '\',\'' . STUDENT_STATUS_1 . '\',\'' . $sc->student_class_id . '\');"><span class="">' . STUDENT_STATUS_1 . '</span></a>';                                $action_class .= '&nbsp;<a style="display: inline-block; margin-bottom: 5px;" href="#student_action" class="label label-info" data-toggle="modal" onclick="load_student_action(\'' . $row['id'] . '\',\'' . $row['branch_id'] . '\',\'' . STUDENT_STATUS_2 . '\',\'' . $sc->student_class_id . '\');"><span class="">' . STUDENT_STATUS_2 . '</span></a>';                                $action_class .= '&nbsp;<a style="display: inline-block; margin-bottom: 5px;" href="#class_attendance" data-toggle="modal" class="label label-info"  onclick="load_class_attendance(\'' . $sc->class_id . '\',\'' . $sc->student_class_id . '\');"><span>Điểm danh</span></a>';                                $action_class .= '&nbsp;<a style="display: inline-block; margin-bottom: 5px;" href="#student_action" class="label label-info" data-toggle="modal" onclick="load_student_action(\'' . $row['id'] . '\',\'' . $row['branch_id'] . '\',\'' . STUDENT_STATUS_7 . '\',\'' . $sc->student_class_id . '\');"><span class="">' . STUDENT_STATUS_7 . '</span></a>';                            }                            if ($current_action->action == STUDENT_STATUS_1) { // Bảo lưu                                $action_class .= '<span style="font-size: 12px;">Bảo lưu đến ngày: ' . date('d/m/Y', strtotime($current_action->to)) . (!empty($current_action->note) ? '<br/>Lý do: ' . $current_action->note : '') . '</span>';                                $action_class .= '<br/><a style="display: inline-block; margin-bottom: 5px;" href="#student_action" class="label label-info" data-toggle="modal" onclick="load_student_action(\'' . $row['id'] . '\',\'' . $row['branch_id'] . '\',\'' . STUDENT_STATUS_6 . '\',\'' . $sc->student_class_id . '\');"><span class="">' . STUDENT_STATUS_6 . '</span></a>';                            }                        }                    }                }            }            $status = ($row['status'] == 1) ? '<span class="text-success">Active</span>' : '<span class="text-danger">Inactive</span>';            $cate = array(                $row['student_code'],                $text,                $status,                $action_class,                '<a href="#student_detail" data-toggle="modal" onclick="load_student_edit(\'' . $row['id'] . '\');"><span style="font-size: 20px;" class="fa fa-edit"></span></a><a href="javascript:;" onclick="delete_student(\'' . $row['id'] . '\');"><span style="font-size: 20px;" class="fa fa-times text-danger"></span></a>',            );            $data['aaData'][] = $cate;        endforeach;        echo json_encode($data);    }    function check_special_hour()    {        $total_hour = 0;        $special_price = 0;        if ($this->input->post('from') && $this->input->post('to') && $this->input->post('change_class')) {            $student_class_from = $this->studentclassm->get_item_by_id($this->input->post('from'));            if ($student_class_from != null) {                $class_from = $this->classm->get_item_by_id($student_class_from['class_id']);                if (isset($class_from['is_special']) && $class_from['is_special'] == 0) {                    $class_to = $this->classm->get_item_by_id($this->input->post('to'));                    if (isset($class_to['is_special']) && $class_to['is_special'] == 1) {                        $branch_data = $this->branchm->get_item_by_id($this->session->userdata('branch'));                        $special_price = $branch_data['special_hour'];                        /* tinh toan thoi gian hoc o lop moi */                        if ($this->input->post('change_class') == "true") {                            $student_class = $this->studentclassm->get_items_by_student_program_id($student_class_from['student_id'], $student_class_from['program_id']);                            $list_student_class_id = array();                            foreach ($student_class->result() as $val) {                                $list_student_class_id[] = $val->student_class_id;                            }                            $schedule_data = excuteMultiClassInProgram($list_student_class_id);                            if (isset($schedule_data['data'])) {                                foreach ($schedule_data['data'] as $value) {                                    if ($value['student_class_id'] == $student_class_from['student_class_id'] && $value['day_int'] > time()) {                                        $total_hour += $value['hour'];                                    }                                }                            }                        } else {                            $total_hour = $student_class_from['hour'];                        }                    }                }            }        }        echo json_encode(array(            'hour' => $total_hour,            'money_per_hour' => $special_price,            'money' => $total_hour * $special_price,            'show_money' => $total_hour . "(h) x " . number_format($special_price) . "đ = " . number_format($total_hour * $special_price) . "đ",        ));    }    function delete_student()    {        if ($this->input->post('id')) {            $id = $this->input->post('id');            $ids = explode(',', $id);            foreach ($ids as $id) {                if (!empty($id)) {                    $this->db->update($this->prefix . 'student', array('deleted' => 1), array('student_id' => $id));                }            }        }    }    function change_branch($student_id, $from_branch, $to_branch)    {        $this->db->update($this->prefix . 'student', array('branch_id' => $to_branch), array('student_id' => $student_id, 'status' => 1, 'deleted' => 0, 'branch_id' => $from_branch));        $this->db->update($this->prefix . 'action', array('branch_id' => $to_branch), array('object_id' => $student_id, 'branch_id' => $from_branch));    }    function save_student_branch_transfer()    {        if ($this->input->post('id') != "" && $this->input->post('type') != "") {            $id = $this->input->post('id');            $type = $this->input->post('type');            if ($type == "1") { // accept                $action_data = $this->actionm->get_item_by_id($id);                if ($action_data != null) {                    $this->change_branch($action_data['object_id'], $action_data['from'], $action_data['to']);                    $this->db->update($this->prefix . 'action', array('deleted' => 1), array('action_id' => $id));                }            } else { //delete                $this->db->update($this->prefix . 'action', array('deleted' => 1), array('action_id' => $id));            }        }    }    function save_student_add()    {        $data = array(            'student_id' => $this->uuid->v4(),            'name' => $this->input->post('name'),            'student_code' => $this->studentm->generate_code($this->session->userdata('branch')),            'sex' => $this->input->post('sex'),            'birthday' => format_save_date($this->input->post('birthday')),            'student_school' => $this->input->post('student_school'),            'student_class' => $this->input->post('student_class'),            'parent_name' => $this->input->post('parent_name'),            'parent_type' => $this->input->post('parent_type'),            'parent_birthday' => format_save_date($this->input->post('parent_birthday')),            'parent_work' => $this->input->post('parent_work'),            'address' => $this->input->post('address'),            'phone' => $this->input->post('phone'),            'email' => $this->input->post('email'),            'note' => $this->input->post('note'),            'how_to_know' => $this->input->post('how_to_know'),            'status' => $this->input->post('status'),            'created_at' => date('Y-m-d H:i:s'), // $this->input->post('created_at'),            'updated_at' => date('Y-m-d H:i:s'), // $this->input->post('updated_at'),            'branch_id' => $this->input->post('branch_id'),        );        $save = $this->db->insert($this->prefix . 'student', $data);    }    function save_student_edit()    {        if ($this->input->post('id')) {            $id = $this->input->post('id');            $data = array(                'name' => $this->input->post('name'),                //'student_code' => $this->studentm->generate_code($this->session->userdata('branch')),                'sex' => $this->input->post('sex'),                'birthday' => format_save_date($this->input->post('birthday')),                'student_school' => $this->input->post('student_school'),                'student_class' => $this->input->post('student_class'),                'parent_name' => $this->input->post('parent_name'),                'parent_type' => $this->input->post('parent_type'),                'parent_birthday' => format_save_date($this->input->post('parent_birthday')),                'parent_work' => $this->input->post('parent_work'),                'address' => $this->input->post('address'),                'phone' => $this->input->post('phone'),                'email' => $this->input->post('email'),                'note' => $this->input->post('note'),                'how_to_know' => $this->input->post('how_to_know'),                'status' => $this->input->post('status'),                // 'created_at' => $this->input->post('created_at'),                'updated_at' => date('Y-m-d H:i:s'), // $this->input->post('updated_at'),                'branch_id' => $this->input->post('branch_id'),            );            $save = $this->db->update($this->prefix . 'student', $data, array('student_id' => $id));        }    }    function load_student_add()    {        ?>        <div class="modal-body">            <div class="col-md-6">                <h4>Thông tin học viên</h4>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Trung tâm:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="branch_id" readonly="readonly">                            <option value="">- trung tâm -</option>                            <?php                            $center_list = $this->branchm->get_items();                            foreach ($center_list->result() as $row) {                                ?>                                <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                                <option                                    value="<?php echo $row->branch_id ?>" <?php if ($row->branch_id == $this->session->userdata('branch')) echo 'selected="selected"' ?>><?php echo $row->name ?></option>                            <?php } ?>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <!--<div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Mã học viên:</div>                    </div>                    <div class="col-md-8">                        <input type="text" readonly="readonly"                               value="<?php echo $this->studentm->generate_code($this->session->userdata('branch')); ?>"                               name="student_code" placeholder="mã học viên" class="form-control"></input>                    </div>                </div>-->                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Tên học viên:</div>                    </div>                    <div class="col-md-8">                        <input type="text" name="name" placeholder="tên học viên" class="form-control"></input>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Giới tính:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="sex">                            <option value="">- giới tính -</option>                            <option value="1">Nam</option>                            <option value="2">Nữ</option>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Ngày sinh nhật:</div>                    </div>                    <div class="col-md-8">                        <input type="text" name="birthday" placeholder="ngày sinh nhật"                               class="form-control datepicker"></input>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Trường:</div>                    </div>                    <div class="col-md-8">                        <input type="text" name="student_school" placeholder="trường" class="form-control"></input>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Lớp:</div>                    </div>                    <div class="col-md-8">                        <input type="text" name="student_class" placeholder="lớp" class="form-control"></input>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Ghi chú:</div>                    </div>                    <div class="col-md-8">                        <textarea name="note" placeholder="ghi chú" class="form-control"></textarea>                    </div>                </div>                <div class="clearfix"></div>            </div>            <div class="col-md-6">                <h4>Thông tin phụ huynh</h4>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Tên phụ huynh:</div>                    </div>                    <div class="col-md-8">                        <input type="text" name="parent_name" placeholder="tên phụ huynh" class="form-control"></input>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Mối quan hệ:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="parent_type" id="parent_type">                            <option value="">- mối quan hệ -</option>                            <?php foreach ($this->parent_type as $key => $value) {                                echo '<option value="' . $key . '">' . $value . '</option>';                            } ?>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Sinh nhật phụ huynh:</div>                    </div>                    <div class="col-md-8">                        <input type="text" name="parent_birthday" placeholder="sinh nhật phụ huynh"                               class="form-control datepicker"></input>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Nghề nghiệp:</div>                    </div>                    <div class="col-md-8">                        <input type="text" name="parent_work" placeholder="nghề nghiệp" class="form-control"></input>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Địa chỉ:</div>                    </div>                    <div class="col-md-8">                        <input type="text" name="address" placeholder="địa chỉ" class="form-control"></input>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Số điện thoại:</div>                    </div>                    <div class="col-md-8">                        <input type="text" name="phone" placeholder="số điện thoại" class="form-control"></input>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Email:</div>                    </div>                    <div class="col-md-8">                        <input type="text" name="email" placeholder="email" class="form-control"></input>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Phụ huynh biết MK qua:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="how_to_know" id="how_to_know">                            <option value="">- Chọn kênh phụ huynh biết MK -</option>                            <?php foreach ($this->how_to_know as $key => $value) {                                echo '<option value="' . $key . '">' . $value . '</option>';                            } ?>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Trạng thái:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="status">                            <option value="">- trạng thái -</option>                            <option value="1">Active</option>                            <option value="2">Inactive</option>                        </select>                    </div>                </div>                <div class="clearfix"></div>            </div>            <div class="clearfix"></div>        </div>        <div class="modal-footer">            <a class="btn btn-success" onclick="save_student_add($(this))">lưu</a>            <a data-dismiss="modal" style="display:none;">Processing...</a>            <a class="btn btn-default" data-dismiss="modal">huỷ</a>        </div>        <?php    }    function load_student_edit()    {        $id = $this->input->post('id');        $result = $this->db->where('student_id', $id)->where('deleted', 0)->get($this->prefix . 'student');        if ($result->num_rows() == 0) {            echo '<p style="text-align:center;margin-top:10px;">No data found!</p>';        } else {            $result = $result->row();            ?>            <input type="hidden" name="id" id="id" value="<?php echo $result->student_id ?>"/>            <div class="modal-body">                <div class="col-md-6">                    <h4>Thông tin học viên</h4>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Trung tâm:</div>                        </div>                        <div class="col-md-8">                            <select class="form-control" name="branch_id" readonly="readonly">                                <option value="">- trung tâm -</option>                                <?php                                $center_list = $this->branchm->get_items();                                foreach ($center_list->result() as $row) { ?>                                    <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                                    <option                                        value="<?php echo $row->branch_id ?>" <?php if ($result->branch_id == $row->branch_id) echo 'selected=""'; ?>><?php echo $row->name ?></option>                                <?php } ?>                            </select>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Mã học viên:</div>                        </div>                        <div class="col-md-8">                            <input type="text" name="student_code" readonly="readonly"                                   value="<?php echo $result->student_code ?>" placeholder="mã học viên"                                   class="form-control"></input>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Tên học viên:</div>                        </div>                        <div class="col-md-8">                            <input type="text" name="name" value="<?php echo $result->name ?>"                                   placeholder="tên học viên"                                   class="form-control"></input>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Giới tính:</div>                        </div>                        <div class="col-md-8">                            <select class="form-control" name="sex">                                <option value="">- giới tính -</option>                                <option value="1" <?php if ($result->sex == 1) echo 'selected=""'; ?>>Nam</option>                                <option value="2" <?php if ($result->sex == 2) echo 'selected=""'; ?>>Nữ</option>                            </select>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Ngày sinh nhật:</div>                        </div>                        <div class="col-md-8">                            <input type="text" name="birthday" value="<?php echo format_get_date($result->birthday) ?>"                                   placeholder="ngày sinh nhật" class="form-control datepicker"></input>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Trường:</div>                        </div>                        <div class="col-md-8">                            <input type="text" name="student_school" value="<?php echo $result->student_school ?>"                                   placeholder="trường" class="form-control"></input>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Lớp:</div>                        </div>                        <div class="col-md-8">                            <input type="text" name="student_class" value="<?php echo $result->student_class ?>"                                   placeholder="lớp" class="form-control"></input>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Ghi chú:</div>                        </div>                        <div class="col-md-8">                            <textarea name="note" placeholder="ghi chú"                                      class="form-control"><?php echo $result->note ?></textarea>                        </div>                    </div>                    <div class="clearfix"></div>                </div>                <div class="col-md-6">                    <h4>Thông tin phụ huynh</h4>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Tên phụ huynh:</div>                        </div>                        <div class="col-md-8">                            <input type="text" name="parent_name" value="<?php echo $result->parent_name ?>"                                   placeholder="tên phụ huynh" class="form-control"></input>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Mối quan hệ:</div>                        </div>                        <div class="col-md-8">                            <select class="form-control" name="parent_type" id="parent_type">                                <option value="">- mối quan hệ -</option>                                <?php foreach ($this->parent_type as $key => $value) { ?>                                    <option                                        value="<?php echo $key ?>" <?php if ($result->parent_type == $key) echo 'selected=""'; ?>><?php echo $value ?></option>                                <?php } ?>                            </select>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Sinh nhật phụ huynh:</div>                        </div>                        <div class="col-md-8">                            <input type="text" name="parent_birthday"                                   value="<?php echo format_get_date($result->parent_birthday) ?>"                                   placeholder="sinh nhật phụ huynh" class="form-control datepicker"></input>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Nghề nghiệp:</div>                        </div>                        <div class="col-md-8">                            <input type="text" name="parent_work" value="<?php echo $result->parent_work ?>"                                   placeholder="nghề nghiệp" class="form-control"></input>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Địa chỉ:</div>                        </div>                        <div class="col-md-8">                            <input type="text" name="address" value="<?php echo $result->address ?>"                                   placeholder="địa chỉ"                                   class="form-control"></input>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Số điện thoại:</div>                        </div>                        <div class="col-md-8">                            <input type="text" name="phone" value="<?php echo $result->phone ?>"                                   placeholder="số điện thoại"                                   class="form-control"></input>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Email:</div>                        </div>                        <div class="col-md-8">                            <input type="text" name="email" value="<?php echo $result->email ?>" placeholder="email"                                   class="form-control"></input>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Phụ huynh biết MK qua:</div>                        </div>                        <div class="col-md-8">                            <select class="form-control" name="how_to_know" id="how_to_know">                                <option value="">- Chọn kênh phụ huynh biết MK -</option>                                <?php foreach ($this->how_to_know as $key => $value) { ?>                                    <option                                        value="<?php echo $key ?>" <?php if ($result->how_to_know == $key) echo 'selected=""'; ?>><?php echo $value ?></option>';                                <?php } ?>                            </select>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Trạng thái:</div>                        </div>                        <div class="col-md-8">                            <select class="form-control" name="status">                                <option value="">- trạng thái -</option>                                <option value="1" <?php if ($result->status == 1) echo 'selected=""'; ?>>Active</option>                                <option value="2" <?php if ($result->status == 2) echo 'selected=""'; ?>>Inactive                                </option>                            </select>                        </div>                    </div>                    <div class="clearfix"></div>                </div>                <div class="clearfix"></div>            </div>            <div class="modal-footer">                <a class="btn btn-success" onclick="save_student_edit($(this))">lưu</a>                <a data-dismiss="modal" style="display:none;">Processing...</a>                <a class="btn btn-default" data-dismiss="modal">huỷ</a>            </div>            <?php        }    }    function load_student_action()    {        $id = $this->input->post('id');        $branch_id = $this->input->post('branch_id');        $branch_data = $this->branchm->get_item_by_id($branch_id);        $action = $this->input->post('action'); ?>        <input type="hidden" name="object_id" id="object_id" value="<?php echo $id ?>"/>        <input type="hidden" name="action" id="action" value="<?php echo $action ?>"/>        <input type="hidden" name="student_class_id" id="student_class_id"               value="<?php echo $this->input->post('student_class_id') ?>"/>        <?php        // -------------------------------   Đăng ký mới || Đăng ký học tiếp   -------------------------------        if ($action == STUDENT_STATUS_0 || $action == STUDENT_STATUS_5) {            $student_money = $this->db->select('sum(money) as total_money')                ->where('deleted', 0)                ->where('student_id', $id)                ->get($this->prefix . 'student_money')                ->row_array();            $branch = $this->branchm->get_item_by_id($this->session->userdata('branch'));            $sql = "SELECT program_id, name                    FROM " . $this->prefix . "program p                    JOIN " . $this->prefix . "action a ON a.`from` = p.program_id                    WHERE a.deleted =  0                    AND p.deleted =  0                    AND a.object_id = ?                    AND a.action = ?                    AND p.branch_id = ?";            $paid_program = $this->db->query($sql, array($id, STUDENT_STATUS_11, $this->session->userdata('branch')));            ?>            <input type="hidden" name="type"                   value="<?php echo ($action == STUDENT_STATUS_0) ? INVOICE_TYPE_0 : INVOICE_TYPE_1 ?>">            <input type="hidden" name="special_hour" value="<?php echo floatval($branch['special_hour']); ?>">            <div class="modal-body">                <div class="col-md-6">                    <h4 id="student_signup"><?php echo $action ?></h4>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Trung tâm:</div>                        </div>                        <div class="col-md-8">                            <select class="form-control" name="branch_id" readonly="readonly">                                <?php                                $center_list = $this->branchm->get_items();                                foreach ($center_list->result() as $row) {                                    ?>                                    <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                                    <option                                        value="<?php echo $row->branch_id ?>" <?php if ($row->branch_id == $this->session->userdata('branch')) echo 'selected="selected"' ?>><?php echo $row->name ?></option>                                <?php } ?>                            </select>                        </div>                    </div>                    <div class="clearfix"></div>                    <?php if ($paid_program->num_rows > 0) : ?>                        <div class="form-group m-t-sm">                            <div class="col-md-4">                                <div class="m-t-sm">Đã thanh toán học phí:</div>                            </div>                            <div class="col-md-8">                                <select class="form-control" name="paid_program_id"                                        onchange="load_paid_program($(this));">                                    <option value="">-- chọn chương trình --</option>                                    <?php                                    foreach ($paid_program->result() as $row) {                                        ?>                                        <option value="<?php echo $row->program_id ?>"><?php echo $row->name ?></option>                                    <?php } ?>                                </select>                            </div>                        </div>                        <div class="clearfix"></div>                    <?php endif; ?>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Chương trình học:</div>                        </div>                        <div class="col-md-6">                            <select class="form-control" name="program_id" onchange="load_program_fee($(this));">                                <option value="">-- chọn chương trình học --</option>                                <?php                                // Lay chuong trinh chua hoc, da nghi hoc, hoac dang hoc thu                                $sql = "SELECT DISTINCT program_id, name, total_time, price                                        FROM " . $this->prefix . "program                                        WHERE                                            status = 1                                            AND deleted = 0                                            AND (program_id NOT IN (SELECT program_id                                                                FROM " . $this->prefix . "student_class                                                                WHERE                                                                    student_id = ?                                                                    AND status = 1                                                                    AND deleted = 0)                                                OR program_id IN (SELECT program_id                                                                FROM " . $this->prefix . "student_class sc                                                                INNER JOIN " . $this->prefix . "action a ON a.from = sc.student_class_id                                                                WHERE                                                                    action = ?                                                                    AND a.object_id = ?                                                                    AND a.deleted = 0                                                                    AND sc.status = 1                                                                    AND sc.deleted = 0)                                                OR program_id IN (SELECT program_id                                                                FROM " . $this->prefix . "student_class sc                                                                INNER JOIN " . $this->prefix . "action a ON a.to = sc.student_class_id                                                                WHERE                                                                    action = ?                                                                    AND a.object_id = ?                                                                    AND a.deleted = 0                                                                    AND sc.status = 1                                                                    AND sc.deleted = 0))                                            AND branch_id = ?                                            ORDER BY name ASC";                                $program_list = $this->db->query($sql, array(                                    $id,                                    STUDENT_STATUS_10,                                    $id,                                    STUDENT_STATUS_4,                                    $id,                                    $this->session->userdata('branch')                                ));                                foreach ($program_list->result() as $row) { ?>                                    <option data-totaltime="<?php echo $row->total_time ?>" data-price="<?php echo $row->price ?>" value="<?php echo $row->program_id ?>"><?php echo $row->name ?></option>                                <?php } ?>                            </select>                        </div>                        <div class="col-md-2">                            <button type="button" class="btn btn-default" aria-label="Justify"                                    onclick="add_more_program($(this));">                                <span class="glyphicon glyphicon-plus-sign" aria-hidden="true"></span>                            </button>                        </div>                    </div>                    <div id="more-program-content"></div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Sự kiện:</div>                        </div>                        <div class="col-md-8">                            <select class="form-control" name="event_id">                                <option value="" data-discount="0">-- chọn sự kiện --</option>                                <?php                                $event_list = $this->eventm->get_active_event();                                foreach ($event_list->result() as $row) {                                    ?>                                    <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                                    <option data-discount="<?php echo $row->discount ?>"                                            data-discount-percent="<?php echo $row->discount_percent ?>"                                            value="<?php echo $row->event_id ?>"><?php echo $row->name ?></option>                                <?php } ?>                            </select>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Lớp:</div>                        </div>                        <div class="col-md-6">                            <select class="form-control" name="class_id[default]" onchange="load_surcharge($(this));">                                <?php                                // Lay lop chua hoc, da nghi hoc, hoac dang hoc thu                                $sql = "SELECT DISTINCT class_id, class_code, is_special                                        FROM " . $this->prefix . "class                                        WHERE status = 1                                            AND deleted = 0                                            AND (class_id NOT IN (SELECT class_id                                                                FROM " . $this->prefix . "student_class                                                                WHERE                                                                    student_id = ?                                                                    AND status = 1                                                                    AND deleted = 0)                                                OR class_id IN (SELECT class_id                                                                FROM " . $this->prefix . "student_class sc                                                                INNER JOIN " . $this->prefix . "action a ON a.from = sc.student_class_id                                                                WHERE                                                                    action = ?                                                                    AND a.object_id = ?                                                                    AND a.deleted = 0                                                                    AND sc.status = 1                                                                    AND sc.deleted = 0)                                                OR class_id IN (SELECT class_id                                                                FROM " . $this->prefix . "student_class sc                                                                INNER JOIN " . $this->prefix . "action a ON a.to = sc.student_class_id                                                                WHERE                                                                    action = ?                                                                    AND a.object_id = ?                                                                    AND a.deleted = 0                                                                    AND sc.status = 1                                                                    AND sc.deleted = 0))                                            AND branch_id = ? ORDER BY class_code ASC";                                $class_list = $this->db->query($sql, array(                                    $id,                                    STUDENT_STATUS_10,                                    $id,                                    STUDENT_STATUS_4,                                    $id,                                    $this->session->userdata('branch')                                ));                                foreach ($class_list->result() as $row) {                                    $class_hour = $this->classhourm->get_item_by_class_id($row->class_id);                                    if (empty($class_hour)) continue;                                    ?>                                    <option data="<?php echo $class_hour['date_id'] ?>"                                            value="<?php echo $row->class_id ?>"                                            data-special="<?php echo $row->is_special ?>">                                        <?php echo !empty($row->name) ? $row->name : $row->class_code ?>                                    </option>                                <?php } ?>                            </select>                        </div>                        <div class="col-md-2">                            <button type="button" class="btn btn-default" aria-label="Justify"                                    onclick="add_more_class($(this));">                                <span class="glyphicon glyphicon-plus-sign" aria-hidden="true"></span>                            </button>                        </div>                    </div>                    <div id="more-class-content"></div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Ngày bắt đầu học:</div>                        </div>                        <div class="col-md-8">                            <input type="text" name="date_start" placeholder="ngày bắt đầu học"                                   class="form-control datepicker"                                   value=""></input>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Số giờ học 1 buổi:</div>                        </div>                        <div class="col-md-8">                            <select class="form-control" name="hour" onchange="calculate_price();">                                <option value="2">2</option>                                <option value="1">1</option>                            </select>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Ghi chú:</div>                        </div>                        <div class="col-md-8">                        <textarea name="note" placeholder="ghi chú"                                  class="form-control"></textarea>                        </div>                    </div>                    <div class="clearfix"></div>                </div>                <div class="col-md-6">                    <h4>Phiếu Thu</h4>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Mã phiếu thu:</div>                        </div>                        <div class="col-md-8">                            <input type="text" readonly="readonly"                                   value="<?php echo $this->invoicem->generate_code($this->session->userdata('branch')); ?>"                                   name="invoice_code" class="form-control"></input>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Chiết khấu trực tiếp:</div>                        </div>                        <div class="col-md-8">                            <input type="text" name="extra_discount" placeholder="chiết khấu trực tiếp"                                   class="form-control"                                   value="0"></input>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Phụ thu trực tiếp:</div>                        </div>                        <div class="col-md-8">                            <input type="text" name="surcharge" placeholder="phụ thu trực tiếp"                                   class="form-control"                                   value="0"></input>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Mã phiếu đặt cọc:</div>                        </div>                        <div class="col-md-8">                            <select class="form-control" name="deposit_invoice_id">                                <option value="">-- chọn mã phiếu đặt cọc --</option>                                <?php                                $invoice_list = $this->invoicem->get_item_by_student_id($id, INVOICE_TYPE_6);                                foreach ($invoice_list->result() as $row) {                                    if ($row->branch_id != $this->session->userdata('branch')) continue;                                    if ($row->is_used == 1) continue;                                    ?>                                    <option data-discount="<?php echo $row->total ?>"                                            value="<?php echo $row->invoice_id ?>"><?php echo $row->invoice_code ?></option>                                <?php } ?>                            </select>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Mã phiếu học thử:</div>                        </div>                        <div class="col-md-8">                            <select class="form-control" name="free_invoice_id" onchange="load_free_invoice($(this));">                                <option value="">-- chọn mã phiếu học thử --</option>                                <?php                                $invoice_list = $this->invoicem->get_item_by_student_id($id, INVOICE_TYPE_2);                                foreach ($invoice_list->result() as $row) {                                    if ($row->branch_id != $this->session->userdata('branch')) continue;                                    if ($row->is_used == 1) continue;                                    $detail = $this->invoicedetailm->get_items_by_invoice($row->invoice_id);                                    $p_id = '';                                    $pp_id = array();                                    foreach ($detail as $d) {                                        if ($d['type'] == INVOICE_DETAIL_TYPE_1) {                                            $p_id = $d['object_id'];                                        } else {                                            $pp_id[] = $d['object_id'];                                        }                                    }                                    ?>                                    <option data-program="<?php echo $p_id ?>"                                            data-product="<?php echo implode('|', $pp_id) ?>"                                            data-freehour="<?php echo $row->other ?>"                                            value="<?php echo $row->invoice_id ?>"><?php echo $row->invoice_code ?></option>                                <?php } ?>                            </select>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Số buổi học thử:</div>                        </div>                        <div class="col-md-8">                            <select class="form-control" name="free_hour">                                <option value="">-- chọn số buổi học thử --</option>                                <option value="5">5</option>                                <option value="4">4</option>                                <option value="3">3</option>                                <option value="2">2</option>                                <option value="1">1</option>                            </select>                        </div>                    </div>                    <div class="clearfix"></div>                    <?php if (!empty($student_money['total_money'])) : ?>                        <div class="form-group m-t-sm">                            <div class="col-md-4">                                <div class="m-t-sm">Tiền tích lũy:</div>                            </div>                            <div class="col-md-8">                                <input type="text" readonly="readonly"                                       data-discount="<?php echo $student_money['total_money']; ?>"                                       value="<?php echo number_format($student_money['total_money'], 0); ?>"                                       name="student_money" class="form-control"></input>                            </div>                        </div>                        <div class="clearfix"></div>                    <?php endif; ?>                    <div class="form-group m-t-sm hide">                        <div class="col-md-4">                            <div class="m-t-sm">Phụ thu giờ vàng:</div>                        </div>                        <div class="col-md-8">                            <input type="text" value="0" name="surcharge_special_hour" class="form-control"></input>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="table-container table-responsive m-t hide">                        <table class="table table-striped table-bordered table-hover" id="table-invoice">                            <thead>                            <tr role="row" class="heading">                                <th width="15%" class="text-center">                                    Chi phí                                </th>                                <th width="8%" class="text-center">                                    Giá                                </th>                                <th width="5%" class="text-center">                                    SL                                </th>                                <th width="5%" class="text-center">                                    %                                </th>                                <th width="5%" class="text-center">                                    Thành tiền                                </th>                            </tr>                            </thead>                            <tbody></tbody>                            <tfoot>                            <tr>                                <th colspan="4">                                    <strong>Tổng tiền </strong>                                </th>                                <th>                                    <strong id="sub_total">0</strong>                                    <input type="hidden" name="sub_total" value="0">                                </th>                            </tr>                            <tr>                                <th colspan="4">                                    <strong>Chiết khấu </strong>                                </th>                                <th>                                    <strong id="discount">0</strong>                                    <input type="hidden" name="discount" value="0">                                </th>                            </tr>                            <tr>                                <th colspan="4">                                    <strong>Phụ thu </strong>                                </th>                                <th>                                    <strong id="surcharge">0</strong>                                </th>                            </tr>                            <tr>                                <th colspan="4">                                    <strong>Thanh toán </strong>                                </th>                                <th>                                    <strong id="total">0</strong>                                    <input type="hidden" name="total" value="0">                                </th>                            </tr>                            </tfoot>                        </table>                    </div>                </div>            </div>        <?php } ?>        <?php        // -------------------------------   Đăng ký học tiếp    -------------------------------        /*if ($action == STUDENT_STATUS_5) {            ?>            <div class="modal-body">                <h4 id="student_signup"><?php echo $action ?></h4>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Trung tâm:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="branch_id" readonly="readonly">                            <?php                            $center_list = $this->branchm->get_items();                            foreach ($center_list->result() as $row) {                                ?>                                <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                                <option                                    value="<?php echo $row->branch_id ?>" <?php if ($row->branch_id == $this->session->userdata('branch')) echo 'selected="selected"' ?>><?php echo $row->name ?></option>                            <?php } ?>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Chương trình học:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="program_id" <!--onchange="load_program_fee();"-->>                            <option value="">-- chọn chương trình học --</option>                            <?php                            $program_list = $this->programm->get_items();                            foreach ($program_list->result() as $row) {                                ?>                                <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                                <option value="<?php echo $row->program_id ?>"><?php echo $row->name ?></option>                            <?php } ?>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Lớp:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="class_id">                            <?php                            $class_list = $this->classm->get_items();                            foreach ($class_list->result() as $row) {                                ?>                                <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                                <?php                                $class_hour = $this->classhourm->get_item_by_class_id($row->class_id);                                if (empty($class_hour)) continue;                                ?>                                <option data="<?php echo $class_hour['date_id'] ?>"                                        value="<?php echo $row->class_id ?>"><?php echo !empty($row->name) ? $row->name : $row->class_code ?></option>                            <?php } ?>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Ngày bắt đầu học:</div>                    </div>                    <div class="col-md-8">                        <input type="text" name="date_start" placeholder="ngày bắt đầu học"                               class="form-control datepicker"                               value="<?php echo format_get_date(date('Y-m-d')); ?>"></input>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Số giờ học 1 buổi:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="hour">                            <option value="2">2</option>                            <option value="1">1</option>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Ghi chú:</div>                    </div>                    <div class="col-md-8">                    <textarea name="note" placeholder="ghi chú"                              class="form-control"></textarea>                    </div>                </div>                <div class="clearfix"></div>            </div>        <?php }*/ ?>        <?php        // -------------------------------   Bảo lưu    -------------------------------        if ($action == STUDENT_STATUS_1) {            ?>            <div class="modal-body">                <h4 id="student_signup"><?php echo $action ?></h4>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Trung tâm:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="branch_id" readonly="readonly">                            <?php                            $center_list = $this->branchm->get_items();                            foreach ($center_list->result() as $row) {                                ?>                                <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                                <option                                    value="<?php echo $row->branch_id ?>" <?php if ($row->branch_id == $this->session->userdata('branch')) echo 'selected="selected"' ?>><?php echo $row->name ?></option>                            <?php } ?>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Lớp:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="class_id" readonly="readonly">                            <?php                            $class_list = $this->classm->get_items();                            foreach ($class_list->result() as $row) {                                ?>                                <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                                <?php                                $studentclass = $this->studentclassm->get_item_by_id($this->input->post('student_class_id'));                                if ($row->class_id != $studentclass['class_id']) continue;                                ?>                                <?php                                $class_hour = $this->classhourm->get_item_by_class_id($row->class_id);                                if (empty($class_hour)) continue;                                ?>                                <option data="<?php echo $class_hour['date_id'] ?>"                                        value="<?php echo $row->class_id ?>"><?php echo !empty($row->name) ? $row->name : $row->class_code ?></option>                            <?php } ?>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Bảo lưu đến ngày:</div>                    </div>                    <div class="col-md-8">                        <input type="text" name="date_end" placeholder="bảo lưu đến ngày"                               class="form-control datepicker" value=""></input>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Lý do:</div>                    </div>                    <div class="col-md-8">                    <textarea name="note" placeholder="lý do"                              class="form-control"></textarea>                    </div>                </div>                <div class="clearfix"></div>            </div>        <?php } ?>        <?php        // -------------------------------   Chuyển lớp   -------------------------------        if ($action == STUDENT_STATUS_2) {            ?>            <div class="modal-body">                <h4 id="student_signup"><?php echo $action ?></h4>                <input type="hidden" name="branch_id" value="<?php echo $this->session->userdata('branch') ?>">                <input type="hidden" name="student_id" value="<?php echo $id; ?>">                <input type="hidden"                       value="<?php echo $this->invoicem->generate_code($this->session->userdata('branch')); ?>"                       name="invoice_code" class="form-control"></input>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Trung tâm:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="branch_id" readonly="readonly">                            <?php                            $center_list = $this->branchm->get_items();                            foreach ($center_list->result() as $row) {                                ?>                                <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                                <option                                    value="<?php echo $row->branch_id ?>" <?php if ($row->branch_id == $this->session->userdata('branch')) echo 'selected="selected"' ?>><?php echo $row->name ?></option>                            <?php } ?>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Lớp hiện tại:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="class_id_from" id="class_id_from" readonly="readonly">                            <?php                            $class_list = $this->classm->get_items();                            foreach ($class_list->result() as $row) {                                ?>                                <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                                <?php                                $studentclass = $this->studentclassm->get_item_by_id($this->input->post('student_class_id'));                                if ($row->class_id != $studentclass['class_id']) continue;                                ?>                                <?php                                $class_hour = $this->classhourm->get_item_by_class_id($row->class_id);                                if (empty($class_hour)) continue;                                ?>                                <option data="<?php echo $class_hour['date_id'] ?>"                                        value="<?php echo $row->class_id ?>"><?php echo !empty($row->name) ? $row->name : $row->class_code ?></option>                            <?php } ?>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Lớp chuyển tới:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="class_id_to"                                onchange="check_special_hour('<?php echo $this->input->post('student_class_id'); ?>',$(this).val(),true)">                            <?php                            $class_list = $this->classm->get_items();                            $studentclass = $this->studentclassm->get_item_by_id($this->input->post('student_class_id'));                            $studentclass_list = $this->studentclassm->get_items_by_student_program_id($id, $studentclass['program_id']);                            $class_id_list = array();                            foreach ($studentclass_list->result() as $v) {                                $class_id_list[] = $v->class_id;                            }                            foreach ($class_list->result() as $row) {                                ?>                                <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                                <?php                                $studentclass = $this->studentclassm->get_item_by_id($this->input->post('student_class_id'));                                if (in_array($row->class_id, $class_id_list)) continue;                                ?>                                <?php                                $class_hour = $this->classhourm->get_item_by_class_id($row->class_id);                                if (empty($class_hour)) continue;                                ?>                                <option data="<?php echo $class_hour['date_id'] ?>"                                        value="<?php echo $row->class_id ?>"><?php echo !empty($row->name) ? $row->name : $row->class_code ?><?php echo $row->is_special == 1 ? "(*)" : ""; ?></option>                            <?php } ?>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <div id="extra_container" class="form-group m-t-sm" style="display: none;">                    <div class="col-md-4">                        <div class="m-t-sm">Phụ thu giờ vàng:</div>                    </div>                    <div class="col-md-8">                        <b id="lbl_extra"></b>                        <input type="hidden" name="extra_hour" id="extra_hour" value="">                        <input type="hidden" name="extra_price" id="extra_price" value="">                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm" style="display: none;">                    <div class="col-md-4">                        <div class="m-t-sm">Ngày bắt đầu chuyển:</div>                    </div>                    <div class="col-md-8">                        <input type="text" name="date_start" placeholder="ngày bắt đầu chuyển"                               class="form-control datepicker" value="<?php echo date('d/m/Y') ?>"></input>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Lý do:</div>                    </div>                    <div class="col-md-8">                    <textarea name="note" placeholder="lý do"                              class="form-control"></textarea>                    </div>                </div>                <div class="clearfix"></div>            </div>        <?php } ?>        <?php        // -------------------------------   Lên lớp   -------------------------------        if ($action == STUDENT_STATUS_3) {            ?>            <div class="modal-body">                <h4 id="student_signup"><?php echo $action ?></h4>                <input type="hidden"                       value="<?php echo $this->invoicem->generate_code($this->session->userdata('branch')); ?>"                       name="invoice_code" class="form-control"></input>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Học viên:</div>                    </div>                    <div class="col-md-8">                        <b><?php echo $this->studentm->get_name($id); ?></b>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Trung tâm:</div>                    </div>                    <div class="col-md-8">                        <?php                        $center_list = $this->branchm->get_items();                        $branch_name = "";                        foreach ($center_list->result() as $row) {                            ?>                            <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                            <?php $branch_name = $row->name; ?>                        <?php } ?>                        <b><?php echo $branch_name; ?></b>                        <input type="hidden" name="branch_id" value="<?php echo $this->session->userdata('branch'); ?>">                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Lớp:</div>                    </div>                    <div class="col-md-8">                        <?php                        $class_list = $this->classm->get_items();                        $class_name = "";                        $class_id = "";                        $studentclass = $this->studentclassm->get_item_by_id($this->input->post('student_class_id'));                        foreach ($class_list->result() as $row) {                            ?>                            <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                            <?php                            if ($row->class_id != $studentclass['class_id']) continue;                            ?>                            <?php                            $class_hour = $this->classhourm->get_item_by_class_id($row->class_id);                            if (empty($class_hour)) continue;                            $class_id = $row->class_id;                            $class_name = $row->class_code;                        } ?>                        <b><?php echo $class_name; ?></b>                        <input type="hidden" name="class_id" value="<?php echo $class_id; ?>">                    </div>                </div>                <div class="clearfix"></div>                <?php                $studentclass = $this->studentclassm->get_item_by_student_id($id);                $multi_student_class_id = array();                $program_id = "";                foreach ($studentclass->result() as $sc) {                    $program_id = $sc->program_id;                    $multi_student_class_id[] = $sc->student_class_id;                }                $schedule_data = excuteMultiClassInProgram($multi_student_class_id);                ?>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Ngày bắt đầu:</div>                    </div>                    <div class="col-md-8"><b><?php echo $schedule_data['date_start']; ?></b></div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Ngày kết thúc:</div>                    </div>                    <div class="col-md-8"><b><?php echo $schedule_data['date_end']; ?></b></div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Số giờ đã học:</div>                    </div>                    <div class="col-md-8">                        <?php                        $program = $this->programm->get_item_by_id($program_id);                        $study_hour_time = 0;                        $study_hour = excuteStudyHour($multi_student_class_id);                        if (isset($study_hour[$id])) {                            $study_hour_time = array_sum($study_hour[$id]);                        }                        $absent_hour = excuteAbsentClass($multi_student_class_id);                        ?>                        <b><?php echo $study_hour_time ?> / <?php echo $program['total_time']; ?> giờ</b>                    </div>                </div>                <div class="clearfix"></div>                <?php                if ($study_hour_time >= $program['total_time']) {                    $show_btn_save = 1;                    $paid_hour = $study_hour_time - $program['total_time'] + (int)$absent_hour;                    ?>                    <!--<div class="form-group m-t-sm">                            <div class="col-md-4">                                <div class="m-t-sm">Số giờ phải gia hạn:</div>                            </div>                            <div class="col-md-8">                            </div>                        </div>                        <div class="clearfix"></div>-->                    <input type="hidden" name="up" value="1">                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Ngày xác nhận lên lớp:</div>                        </div>                        <div class="col-md-8">                            <input type="text" name="date_end" placeholder="ngày xác nhận lên lớp"                                   class="form-control datepicker"></input>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Số tiền phải gia hạn:</div>                        </div>                        <div class="col-md-8">                            <input type="hidden" class="form-control" name="extra_hour"                                   value="<?php echo $paid_hour; ?>">                            <input type="text" class="form-control" name="extra_price"                                   value="<?php echo(round($paid_hour * ($program['price'] / $program['total_time']))); ?>">                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Lý do:</div>                        </div>                        <div class="col-md-8">                    <textarea name="note" placeholder="lý do"                              class="form-control"></textarea>                        </div>                    </div>                    <div class="clearfix"></div>                <?php } else { ?>                    <?php //if(strtotime($schedule_data['date_end']) <= time()) { // phu thu hoc phi ?>                    <?php //} else { ?>                    <br>                    <p>Lưu ý: Chỉ xét duyệt lên lớp khi học viên học đủ thời quan quy định của chương trình. </p>                    <?php // } ?>                <?php } ?>            </div>        <?php } ?>        <?php        // -------------------------------   Nghỉ học    -------------------------------        if ($action == STUDENT_STATUS_4) {            ?>            <div class="modal-body">                <h4 id="student_signup"><?php echo $action ?></h4>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Trung tâm:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="branch_id" readonly="readonly">                            <?php                            $center_list = $this->branchm->get_items();                            foreach ($center_list->result() as $row) {                                ?>                                <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                                <option                                    value="<?php echo $row->branch_id ?>" <?php if ($row->branch_id == $this->session->userdata('branch')) echo 'selected="selected"' ?>><?php echo $row->name ?></option>                            <?php } ?>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Lớp:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="class_id" readonly="readonly">                            <?php                            $class_list = $this->classm->get_items();                            foreach ($class_list->result() as $row) {                                ?>                                <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                                <?php                                $studentclass = $this->studentclassm->get_item_by_id($this->input->post('student_class_id'));                                if ($row->class_id != $studentclass['class_id']) continue;                                ?>                                <?php                                $class_hour = $this->classhourm->get_item_by_class_id($row->class_id);                                if (empty($class_hour)) continue;                                ?>                                <option data="<?php echo $class_hour['date_id'] ?>"                                        value="<?php echo $row->class_id ?>"><?php echo !empty($row->name) ? $row->name : $row->class_code ?></option>                            <?php } ?>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <?php                $studentclass = $this->studentclassm->get_item_by_student_id($id);                $multi_student_class_id = array();                $program_id = "";                foreach ($studentclass->result() as $sc) {                    $program_id = $sc->program_id;                    $multi_student_class_id[] = $sc->student_class_id;                }                $program = $this->programm->get_item_by_id($program_id);                $price_per_hour = round($program['price'] / $program['total_time'], 2);                $schedule_data = excuteFutureHour($multi_student_class_id);                if (isset($schedule_data['total_hour'])) {                    ?>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Số giờ còn lại:</div>                        </div>                        <div class="col-md-8">                            <b><?php echo number_format($schedule_data['total_hour']); ?></b> giờ                            <input type="hidden" name="hour" value="<?php echo $schedule_data['total_hour']; ?>">                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Số tiền quy đổi:</div>                        </div>                        <div class="col-md-8">                            <b><?php echo number_format(round($schedule_data['total_hour'] * $price_per_hour)); ?></b>đ                            <input type="hidden" name="money"                                   value="<?php echo(round($schedule_data['total_hour'] * $price_per_hour)); ?>">                        </div>                    </div>                    <div class="clearfix"></div>                <?php } ?>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Ngày xác nhận nghỉ học:</div>                    </div>                    <div class="col-md-8">                        <input type="text" name="date_start" placeholder="ngày xác nhận nghỉ học"                               class="form-control datepicker">                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Lý do:</div>                    </div>                    <div class="col-md-8">                    <textarea name="note" placeholder="lý do"                              class="form-control"></textarea>                    </div>                </div>                <div class="clearfix"></div>                <br>                <small>*Lưu ý: Số giờ sẽ được quy đổi thành tiền tích luỹ của học viên.</small>            </div>        <?php } ?>        <?php        // -------------------------------   Học tiếp    -------------------------------        if ($action == STUDENT_STATUS_6) {            ?>            <div class="modal-body">                <h4 id="student_signup"><?php echo $action ?></h4>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Trung tâm:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="branch_id" readonly="readonly">                            <?php                            $center_list = $this->branchm->get_items();                            foreach ($center_list->result() as $row) {                                ?>                                <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                                <option                                    value="<?php echo $row->branch_id ?>" <?php if ($row->branch_id == $this->session->userdata('branch')) echo 'selected="selected"' ?>><?php echo $row->name ?></option>                            <?php } ?>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Lớp:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="class_id" readonly="readonly">                            <?php                            $class_list = $this->classm->get_items();                            foreach ($class_list->result() as $row) {                                ?>                                <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                                <?php                                $studentclass = $this->studentclassm->get_item_by_id($this->input->post('student_class_id'));                                if ($row->class_id != $studentclass['class_id']) continue;                                ?>                                <?php                                $class_hour = $this->classhourm->get_item_by_class_id($row->class_id);                                if (empty($class_hour)) continue;                                ?>                                <option data="<?php echo $class_hour['date_id'] ?>"                                        value="<?php echo $row->class_id ?>"><?php echo !empty($row->name) ? $row->name : $row->class_code ?></option>                            <?php } ?>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Ngày bắt đầu lại:</div>                    </div>                    <div class="col-md-8">                        <input type="text" name="date_start" placeholder="ngày bắt đầu lại"                               class="form-control datepicker"></input>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm" style="display: none;">                    <div class="col-md-4">                        <div class="m-t-sm">Ghi chú:</div>                    </div>                    <div class="col-md-8">                    <textarea name="note" placeholder="ghi chú"                              class="form-control"></textarea>                    </div>                </div>                <div class="clearfix"></div>            </div>        <?php } ?>        <?php        // -------------------------------   Học tiếp    -------------------------------        if ($action == STUDENT_STATUS_14) {            $student_class_data = $this->studentclassm->get_item_by_id($this->input->post('student_class_id'));            //$program_data = $this->programm->get_item_by_id($student_class_data["program_id"]);            $student_class_datas = $this->studentclassm->get_items_by_student_program_id($id,$student_class_data["program_id"]);            $list_id =  array();            foreach($student_class_datas->result() as $student_class) {                if(!in_array($student_class->class_id,$list_id)) {                    $list_id[] = $student_class->class_id;                }            }            ?>            <div class="modal-body">                <h4 id="student_signup"><?php echo $action ?></h4>                <input type="hidden" name="program_id" value="<?php echo $student_class_data["program_id"]; ?>">                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Trung tâm:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="branch_id" readonly="readonly">                            <?php                            $center_list = $this->branchm->get_items();                            foreach ($center_list->result() as $row) {                                ?>                                <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                                <option                                    value="<?php echo $row->branch_id ?>" <?php if ($row->branch_id == $this->session->userdata('branch')) echo 'selected="selected"' ?>><?php echo $row->name ?></option>                            <?php } ?>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Lớp:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="class_id">                            <?php                            $class_list = $this->classm->get_items();                            foreach ($class_list->result() as $row) {                                ?>                                <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                                <?php                                //$studentclass = $this->studentclassm->get_item_by_id($this->input->post('student_class_id'));                                if (in_array($row->class_id,$list_id)) continue;                                ?>                                <?php                                $class_hour = $this->classhourm->get_item_by_class_id($row->class_id);                                if (empty($class_hour)) continue;                                ?>                                <option data="<?php echo $class_hour['date_id'] ?>"                                        value="<?php echo $row->class_id ?>"><?php echo !empty($row->name) ? $row->name : $row->class_code ?></option>                            <?php } ?>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm" style="display: none;">                    <div class="col-md-4">                        <div class="m-t-sm">Ghi chú:</div>                    </div>                    <div class="col-md-8">                    <textarea name="note" placeholder="ghi chú"                              class="form-control"></textarea>                    </div>                </div>                <div class="clearfix"></div>            </div>        <?php } ?>        <?php        // -------------------------------   chuyen gio   -------------------------------        if ($action == STUDENT_STATUS_12) {            $student_class_id = $this->input->post('student_class_id');            $student_class_data = $this->studentclassm->get_item_by_id($student_class_id);            if ((int)$student_class_data['hour'] == 2) {                $show_btn_save = 1;            }            ?>            <div class="modal-body">                <h4 id="student_signup"><?php echo $action ?></h4>                <input type="hidden" name="branch_id" value="<?php echo $this->session->userdata('branch') ?>">                <input type="hidden" name="object_id" value="<?php echo $id; ?>">                <input type="hidden" name="student_class_id" value="<?php echo $student_class_id; ?>">                <input type="hidden" name="type" value="<?php echo $action; ?>">                <input type="hidden"                       value="<?php echo $this->invoicem->generate_code($this->session->userdata('branch')); ?>"                       name="invoice_code" class="form-control"></input>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Trung tâm:</div>                    </div>                    <div class="col-md-8">                        <?php                        $center_list = $this->branchm->get_items();                        foreach ($center_list->result() as $row) {                            ?>                            <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                            <?php echo $row->name ?>                        <?php } ?>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Giờ hiện tại:</div>                    </div>                    <div class="col-md-8">                        <b><?php echo (int)$student_class_data['hour']; ?> Giờ / buổi</b>                        <input type="hidden" name="from_hour" class="form-control"                               value="<?php echo (int)$student_class_data['hour']; ?>">                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Chuyển thành:</div>                    </div>                    <div class="col-md-8">                        <b><?php echo(3 - (int)$student_class_data['hour']); ?> Giờ / buổi</b>                        <input type="hidden" name="to_hour" class="form-control"                               value="<?php echo(3 - (int)$student_class_data['hour']); ?>">                    </div>                </div>                <div class="clearfix"></div>                <?php if ((int)$student_class_data['hour'] == 2) { ?>                    <div id="extra_container" class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Phụ thu chuyển giờ:</div>                        </div>                        <div class="col-md-8">                            <input type="text" name="extra_price" class="form-control"                                   value="<?php echo isset($branch_data['fee_change_hour']) ? $branch_data['fee_change_hour'] : 0; ?>">                        </div>                    </div>                    <div class="clearfix"></div>                <?php } ?>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Lý do:</div>                    </div>                    <div class="col-md-8">                    <textarea name="note" placeholder="lý do"                              class="form-control"></textarea>                    </div>                </div>                <div class="clearfix"></div>            </div>        <?php } ?>        <?php        // -------------------------------   gia han   -------------------------------        if ($action == STUDENT_STATUS_13) {            $student_class_id = $this->input->post('student_class_id');            $student_class_data = $this->studentclassm->get_item_by_id($student_class_id);            if ($student_class_data != null) {                $extra = $this->actionm->get_extra_days_action($this->session->userdata('branch'), $id, $student_class_data['program_id']);                ?>                <div class="modal-body">                    <h4 id="student_signup"><?php echo $action ?></h4>                    <input type="hidden" name="branch_id" value="<?php echo $this->session->userdata('branch') ?>">                    <input type="hidden" name="object_id" value="<?php echo $id; ?>">                    <input type="hidden" name="student_class_id" value="<?php echo $student_class_id; ?>">                    <input type="hidden" name="type" value="<?php echo $action; ?>">                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Trung tâm:</div>                        </div>                        <div class="col-md-8">                            <select class="form-control" name="branch_id" readonly="readonly">                                <?php                                $center_list = $this->branchm->get_items();                                foreach ($center_list->result() as $row) {                                    ?>                                    <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                                    <option                                        value="<?php echo $row->branch_id ?>" <?php if ($row->branch_id == $this->session->userdata('branch')) echo 'selected="selected"' ?>><?php echo $row->name ?></option>                                <?php } ?>                            </select>                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Số buổi đã gia hạn:</div>                        </div>                        <div class="col-md-8">                            <b><?php echo $extra; ?> Buổi</b>                        </div>                    </div>                    <div class="clearfix"></div>                    <div id="extra_container" class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Số buổi muốn gia hạn thêm:</div>                        </div>                        <div class="col-md-8">                            <input type="text" name="extra_days" class="form-control"                                   placeholder="Nhập số buổi muốn gia hạn" value="">                        </div>                    </div>                    <div class="clearfix"></div>                    <div class="form-group m-t-sm">                        <div class="col-md-4">                            <div class="m-t-sm">Lý do:</div>                        </div>                        <div class="col-md-8">                    <textarea name="note" placeholder="lý do"                              class="form-control"></textarea>                        </div>                    </div>                    <div class="clearfix"></div>                </div>            <?php } else { ?>                <div class="modal-body">                    <p>* Lớp này không tồn tại, xin vui lòng kiểm tra lại.</p>                </div>            <?php } ?>        <?php } ?>        <?php        // -------------------------------   Xóa   -------------------------------        if ($action == STUDENT_STATUS_7) {            ?>            <div class="modal-body">                <h4 id="student_signup"><?php echo $action ?></h4>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Trung tâm:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="branch_id" readonly="readonly">                            <?php                            $center_list = $this->branchm->get_items();                            foreach ($center_list->result() as $row) {                                ?>                                <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                                <option                                    value="<?php echo $row->branch_id ?>" <?php if ($row->branch_id == $this->session->userdata('branch')) echo 'selected="selected"' ?>><?php echo $row->name ?></option>                            <?php } ?>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Lớp:</div>                    </div>                    <div class="col-md-8">                        <select class="form-control" name="class_id" readonly="readonly">                            <?php                            $class_list = $this->classm->get_items();                            foreach ($class_list->result() as $row) {                                ?>                                <?php if ($row->branch_id != $this->session->userdata('branch')) continue; ?>                                <?php                                $studentclass = $this->studentclassm->get_item_by_id($this->input->post('student_class_id'));                                if ($row->class_id != $studentclass['class_id']) continue;                                ?>                                <?php                                $class_hour = $this->classhourm->get_item_by_class_id($row->class_id);                                if (empty($class_hour)) continue;                                ?>                                <option data="<?php echo $class_hour['date_id'] ?>"                                        value="<?php echo $row->class_id ?>"><?php echo !empty($row->name) ? $row->name : $row->class_code ?></option>                            <?php } ?>                        </select>                    </div>                </div>                <div class="clearfix"></div>                <div class="form-group m-t-sm">                    <div class="col-md-4">                        <div class="m-t-sm">Lý do:</div>                    </div>                    <div class="col-md-8">                    <textarea name="note" placeholder="lý do"                              class="form-control"></textarea>                    </div>                </div>                <div class="clearfix"></div>            </div>        <?php } ?>        <?php if ($action == STUDENT_STATUS_0 || $action == STUDENT_STATUS_5) { ?>        <div class="clearfix m-b"></div>    <?php } ?>        <div class="modal-footer">            <span id="btn_container"></span>            <?php if ($action == STUDENT_STATUS_0 || $action == STUDENT_STATUS_5) { ?>                <a class="btn btn-success" onclick="save_student_action($(this), true)">Lưu và In</a>            <?php } else if (($action == STUDENT_STATUS_3 || $action == STUDENT_STATUS_12) && isset($show_btn_save) && $show_btn_save == 1) { ?>                <a class="btn btn-success" onclick="save_student_action($(this), true)">Lưu và In</a>            <?php } else { ?>                <a class="btn btn-success" onclick="save_student_action($(this), false)">Lưu</a>            <?php } ?>            <a data-dismiss="modal" style="display:none;">Processing...</a>            <a class="btn btn-default" data-dismiss="modal">Huỷ</a>        </div>        <?php    }}